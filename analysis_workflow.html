<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jian Sheng Boey">

<title>Analysis workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="analysis_workflow_files/libs/clipboard/clipboard.min.js"></script>
<script src="analysis_workflow_files/libs/quarto-html/quarto.js"></script>
<script src="analysis_workflow_files/libs/quarto-html/popper.min.js"></script>
<script src="analysis_workflow_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="analysis_workflow_files/libs/quarto-html/anchor.min.js"></script>
<link href="analysis_workflow_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="analysis_workflow_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="analysis_workflow_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="analysis_workflow_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="analysis_workflow_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis workflow</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jian Sheng Boey </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="environment" class="level1">
<h1>Environment</h1>
<section id="load-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-libraries">Load libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fast utilities</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rfast)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rfast2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecological analysis</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangling: Strings</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangling: Tables</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(matrixStats)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional programming</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(listenv)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualisation</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggvenn)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="read-local-data" class="level2">
<h2 class="anchored" data-anchor-id="read-local-data">Read local data</h2>
<p>Set pattern for data source.</p>
</section>
<section id="declare-data-source" class="level2 {callout-note}">
<h2 class="anchored" data-anchor-id="declare-data-source">Declare: Data source</h2>
<p>Data source type is first declared here.</p>
</section>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>srctype <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"WGS"</span>, <span class="st">"WTS"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(srctype) <span class="ot">&lt;-</span> srctype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Import local numerical data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>BINCOV <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"data/bin_coverage.txt"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>COUNTS <span class="ot">&lt;-</span> <span class="fu">lapply</span>(srctype, \(s) <span class="fu">fread</span>(<span class="fu">glue</span>(<span class="st">"results/{s}_clean_count.tsv.gz"</span>)))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>CONTIGMAP <span class="ot">&lt;-</span> <span class="fu">lapply</span>(srctype, \(s) <span class="fu">fread</span>(<span class="fu">glue</span>(<span class="st">"data/{s}.contig_coverage.tsv"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Import local annotation data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ANNOTATION <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"results/curated_annotation_table.tsv"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>CHECKM <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"results/hq_bins.checkm_data.txt.gz"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>TAXONOMY <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"data/bin_taxonomy_final.txt"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>CAZYME <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">readRDS</span>(<span class="st">"data/curated_cazymes_substrates.rds"</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>METADATA <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"data/sample_metadata.txt"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>SUMMARY <span class="ot">&lt;-</span> <span class="fu">lapply</span>(srctype, \(s) <span class="fu">fread</span>(<span class="fu">glue</span>(<span class="st">"results/{s}_count.tsv.summary"</span>)))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>SUBSTRATE <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"data/curated_dbcansub_substrate_map_2.xlsx"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="clean-data" class="level2">
<h2 class="anchored" data-anchor-id="clean-data">Clean data</h2>
<p>Remove weird <code>_pred</code> suffix in MAG names in <code>ANNOTATION</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ANNOTATION<span class="sc">$</span>bin <span class="ot">&lt;-</span> <span class="fu">str_remove</span>(ANNOTATION<span class="sc">$</span>bin, <span class="st">"_pred$"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename columns <code>BINCOV</code> and convert the data table to matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(BINCOV, \(nm) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(nm, <span class="st">"Filt"</span>) <span class="sc">~</span> <span class="fu">str_replace</span>(nm, <span class="st">"(.*)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1_1"</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(nm, <span class="st">"Sed"</span>) <span class="sc">~</span> <span class="fu">str_remove</span>(nm, <span class="st">"Sample"</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> nm</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>BINCOV <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(BINCOV[, <span class="sc">-</span><span class="dv">1</span>], <span class="at">rownames =</span> BINCOV<span class="sc">$</span>bin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename columns in <code>CHECKM</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(CHECKM, \(nm) <span class="fu">str_replace</span>(nm, <span class="st">" "</span>, <span class="st">"_"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Select columns with node ID and sample counts only then convert them to matrices in <code>COUNTS</code>.</p>
<p><code>METADATA$sample</code> is the authoritative vector on samples and their naming convention.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>COUNTS <span class="ot">&lt;-</span> <span class="fu">lapply</span>(COUNTS, \(dt) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(dt)[<span class="fu">names</span>(dt) <span class="sc">%in%</span> METADATA<span class="sc">$</span>sample]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(dt[, .SD, <span class="at">.SDcols =</span> nm], <span class="at">rownames =</span> dt<span class="sc">$</span>Geneid)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename columns in <code>SUMMARY</code> to retain only sample names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>SUMMARY <span class="ot">&lt;-</span> <span class="fu">lapply</span>(SUMMARY, \(dt) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(dt, \(nm) <span class="fu">str_extract</span>(nm, <span class="st">"(Filt|Sed).S</span><span class="sc">\\</span><span class="st">d_</span><span class="sc">\\</span><span class="st">d"</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Expand taxonomic levels then remove irrelavent columns in <code>TAXONOMY</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tax_level <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"domain"</span>, <span class="st">"phylum"</span>, <span class="st">"class"</span>, <span class="st">"order"</span>, <span class="st">"family"</span>, <span class="st">"genus"</span>, <span class="st">"species"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>TAXONOMY <span class="ot">&lt;-</span> TAXONOMY[</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  , (tax_level) <span class="sc">:</span><span class="er">=</span> <span class="fu">tstrsplit</span>(gtdb_taxonomy, <span class="st">";"</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  , (tax_level) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, \(s) <span class="fu">gsub</span>(<span class="st">"[a-z]__"</span>, <span class="st">""</span>, s)), .SDcols <span class="ot">=</span> tax_level</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  , <span class="fu">c</span>(<span class="st">"gtdb_taxonomy"</span>, <span class="st">"taxa"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Split up base coverage and reads mapped in <code>BASECOV</code>, and then convert to matrix. Also store contig length as attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>CONTIGMAP <span class="ot">&lt;-</span> <span class="fu">lapply</span>(CONTIGMAP, \(dt) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">basecov =</span> dt[, .SD, <span class="at">.SDcols =</span> <span class="fu">patterns</span>(<span class="st">"rname|bases"</span>)],</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">readcov =</span> dt[, .SD, <span class="at">.SDcols =</span> <span class="fu">patterns</span>(<span class="st">"rname|reads"</span>)]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>(<span class="at">recursive =</span> <span class="cn">FALSE</span>, <span class="at">use.names =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(., \(dt) {</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt, <span class="at">rownames =</span> <span class="st">"rname"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(m) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">".*.((Sed|Filt).S</span><span class="sc">\\</span><span class="st">d+_</span><span class="sc">\\</span><span class="st">d+)..*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">colnames</span>(m))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(m, <span class="st">"contig.length"</span>) <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">gsub</span>(<span class="st">".*length_(</span><span class="sc">\\</span><span class="st">d+)_.*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">rownames</span>(m))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(m)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="standard-objects" class="level1">
<h1>Standard objects</h1>
<p><strong>Habitat colour and fill</strong></p>
<ul>
<li><span style="color:#F89812;">Sediment: <code>"#F89812"</code></span></li>
<li><span style="color:#25A7F8;">Water : <code>"#25A7F8"</code></span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>habitat_colour <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sediment"</span> <span class="ot">=</span> <span class="st">"#F89812"</span>, <span class="st">"water"</span> <span class="ot">=</span> <span class="st">"#25A7F8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Habitat shape</strong></p>
<ul>
<li>Sediment: 17 (solid triangle)</li>
<li>Water : 19 (solid circle)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>habitat_shape <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"sediment"</span> <span class="ot">=</span> <span class="dv">17</span>, <span class="st">"water"</span> <span class="ot">=</span> <span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Salinity gradient colours</strong></p>
<p>Viridis, palette D, where dark purple is non-saline and yellow is marine.</p>
<p><strong>CAZyme colours</strong></p>
<ul>
<li><span style="color:#CE1235;">GH: <code>"#CE1235"</code></span></li>
<li><span style="color:#59C9A5;">PL: <code>"#59C9A5"</code></span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>cazyme_colour <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GH"</span> <span class="ot">=</span> <span class="st">"#CE1235"</span>, <span class="st">"PL"</span> <span class="ot">=</span> <span class="st">"#59C9A5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>GH and PL encoding nodes</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>gp_node <span class="ot">&lt;-</span> <span class="fu">unique</span>(CAZYME<span class="sc">$</span>NODE[<span class="fu">grepl</span>(<span class="st">"(GH|PL)"</span>, CAZYME<span class="sc">$</span>FAMILY)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Samples shared between WTS and WGS</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>overlap_samples <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(intersect, <span class="fu">lapply</span>(COUNTS, colnames))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="functions" class="level1">
<h1>Functions</h1>
<p>Calculate TPM from <code>COUNTS</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>calcTPM <span class="ot">&lt;-</span> <span class="cf">function</span>(m, gene.length) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate RPK first </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (gene length in kbp)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  rpk <span class="ot">&lt;-</span> <span class="fu">sweep</span>(m, <span class="dv">1</span>, gene.length<span class="sc">/</span><span class="fl">1e3</span>, <span class="st">"/"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># TPM from RPK </span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (normalised to per million reads per kbp)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sweep</span>(rpk, <span class="dv">2</span>, <span class="fu">colSums</span>(rpk)<span class="sc">/</span><span class="fl">1e6</span>, <span class="st">"/"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Partition a matrix based on column pattern and remove zero-sum rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>partMatrix <span class="ot">&lt;-</span> <span class="cf">function</span>(m, pattern) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[, <span class="fu">grepl</span>(pattern, <span class="fu">colnames</span>(m))]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  m[<span class="fu">rowSums2</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span>, ]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perform <code>lapply()</code> at specified depth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>lapplyAtDepth <span class="ot">&lt;-</span> <span class="cf">function</span>(LIST, DEPTH, FUN) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (DEPTH <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(LIST, FUN)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(LIST, <span class="cf">function</span>(l) <span class="fu">lapplyAtDepth</span>(l, DEPTH <span class="sc">-</span> <span class="dv">1</span>, FUN))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unwrapping vectors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>unwrap <span class="ot">&lt;-</span> <span class="cf">function</span>(l) <span class="fu">unique</span>(<span class="fu">unlist</span>(l))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Differences between shared elements of two vectors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>calcVectorDiff <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, method, <span class="at">log =</span> <span class="cn">FALSE</span>, <span class="at">base =</span> <span class="fu">exp</span>(<span class="dv">1</span>)) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Shared elements by name</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  shared_nm <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(x), <span class="fu">names</span>(y))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> x[<span class="fu">names</span>(x) <span class="sc">%in%</span> shared_nm]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> y[<span class="fu">names</span>(y) <span class="sc">%in%</span> shared_nm]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Difference</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    method,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">absdiff =</span> v<span class="sc">-</span>u,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">ratio =</span> v<span class="sc">/</span>u,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">reldiff =</span> (v<span class="sc">-</span>u)<span class="sc">/</span>u</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(log)) delta <span class="ot">&lt;-</span> <span class="fu">log</span>(delta, base)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  delta[<span class="sc">!</span>(<span class="fu">is.na</span>(delta) <span class="sc">|</span> <span class="fu">is.infinite</span>(delta))]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Between matrix <code>calcVectorDiff</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>calcMatrixDiff <span class="ot">&lt;-</span> <span class="cf">function</span>(m1, m2, method, <span class="at">log =</span> <span class="cn">FALSE</span>, <span class="at">base =</span> <span class="fu">exp</span>(<span class="dv">1</span>)) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matrices must share the same name for for at least 1 row and column</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  cond.dimnames <span class="ot">&lt;-</span> <span class="fu">any</span>(<span class="fu">colnames</span>(m1) <span class="sc">%in%</span> <span class="fu">colnames</span>(m2)) <span class="sc">&amp;&amp;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">any</span>(<span class="fu">rownames</span>(m1) <span class="sc">%in%</span> <span class="fu">rownames</span>(m2))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isFALSE</span>(cond.dimnames)) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Matrices must share the same names for at least one row and column"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set variables</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  cnames <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">colnames</span>(m1), <span class="fu">colnames</span>(m2))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(cnames))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(result) <span class="ot">&lt;-</span> cnames</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterate</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">length</span>(cnames))) {</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    cnm <span class="ot">&lt;-</span> cnames[i]</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> m1[, cnm]</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> m2[, cnm]</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    result[[cnm]] <span class="ot">&lt;-</span> <span class="fu">calcVectorDiff</span>(</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      x, y, <span class="at">method =</span> method, <span class="at">log =</span> log, <span class="at">base =</span> base</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarity between shared elements of two vectors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>calcVectorJaccard <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Shared elements by name</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  shared_nm <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(x), <span class="fu">names</span>(y))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> x[<span class="fu">names</span>(x) <span class="sc">%in%</span> shared_nm]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> y[<span class="fu">names</span>(y) <span class="sc">%in%</span> shared_nm]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  uv <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">cbind</span>(u, v))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Similarity</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">-</span> <span class="fu">vegdist</span>(uv, <span class="at">method =</span> <span class="st">"jaccard"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarity (column-wise) between shared elements of two matrices</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>calcMatrixJaccard <span class="ot">&lt;-</span> <span class="cf">function</span>(m1, m2) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matrices must share the same name for for at least 1 row and column</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  cond.dimnames <span class="ot">&lt;-</span> <span class="fu">any</span>(<span class="fu">colnames</span>(m1) <span class="sc">%in%</span> <span class="fu">colnames</span>(m2)) <span class="sc">&amp;&amp;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">any</span>(<span class="fu">rownames</span>(m1) <span class="sc">%in%</span> <span class="fu">rownames</span>(m2))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isFALSE</span>(cond.dimnames)) {</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Matrices must share the same names for at least one row and column"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set variables</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  cnames <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">colnames</span>(m1), <span class="fu">colnames</span>(m2))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(cnames))</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(result) <span class="ot">&lt;-</span> cnames</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterate</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">length</span>(cnames))) {</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    cnm <span class="ot">&lt;-</span> cnames[i]</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> m1[, cnm]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> m2[, cnm]</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    result[[cnm]] <span class="ot">&lt;-</span> <span class="fu">calcVectorJaccard</span>(x, y)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pairwise Pearsonâ€™s correlation with significance testing via Monte Carlo resampling. Parallel threads used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>corPermMat2 <span class="ot">&lt;-</span> <span class="cf">function</span>(mat, path, <span class="at">workers =</span> <span class="dv">1</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">k =</span> <span class="dv">999</span>, <span class="at">p.threshold =</span> <span class="dv">2</span>, <span class="at">rho.threshold =</span> <span class="dv">2</span>) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialise</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (workers <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plan</span>(multisession, <span class="at">workers =</span> workers)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Running with multisession futures</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plan</span>(sequential)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Running with sequential futures</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on.exit</span>(<span class="fu">plan</span>(sequential))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(path)) <span class="fu">dir.create</span>(path, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Outputs are here:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  "</span>, path)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  nr <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mat)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parallel correlations</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">future_lapply</span>(<span class="fu">seq_len</span>(nr <span class="sc">-</span> <span class="dv">1</span>), \(i) {</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    pid <span class="ot">&lt;-</span> <span class="fu">Sys.getpid</span>()</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(path, <span class="st">"/corPermMat2_output."</span>, pid, <span class="st">".csv"</span>)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correlations</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">lapply</span>((i <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>nr, \(j) {</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>      S <span class="ot">&lt;-</span> <span class="fu">permcor</span>(mat[i, ], mat[j, ], k)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">abs</span>(S[[<span class="dv">1</span>]]) <span class="sc">&lt;</span> rho.threshold <span class="sc">&amp;</span> S[[<span class="dv">2</span>]] <span class="sc">&gt;</span> p.threshold) {</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        S <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>          <span class="st">"node1"</span>  <span class="ot">=</span> <span class="fu">rownames</span>(mat)[i],</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>          <span class="st">"node2"</span>  <span class="ot">=</span> <span class="fu">rownames</span>(mat)[j],</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>          <span class="st">"rho"</span>    <span class="ot">=</span> S[[<span class="dv">1</span>]],</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>          <span class="st">"perm.p"</span> <span class="ot">=</span> S[[<span class="dv">2</span>]]</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert list to data.table</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> res[<span class="fu">sapply</span>(res, length) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    res_dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">list_transpose</span>(res))</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Progress message</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">%%</span> <span class="dv">50</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">message</span>(<span class="fu">paste</span>(i, <span class="st">"transcripts processed"</span>))</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> nr <span class="sc">-</span> <span class="dv">1</span>) <span class="fu">message</span>(<span class="st">"Completed"</span>)</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write output</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fwrite</span>(res_dt, <span class="at">file =</span> filename, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">future.seed =</span> <span class="cn">TRUE</span>, <span class="at">future.scheduling =</span> <span class="cn">Inf</span>)</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Getting CAZymes based on substrates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>getCAZyBySubstrate <span class="ot">&lt;-</span> <span class="cf">function</span>(x, action, CAZyme_class) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output should be a list of:</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. EC Numbers</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. CAZyme families</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Specified action mode of the enzyme</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Substrate</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Substrate"</span>, <span class="fu">names</span>(SUBSTRATE), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  f1 <span class="ot">&lt;-</span> SUBSTRATE[</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">Reduce</span>(<span class="st">`</span><span class="at">|</span><span class="st">`</span>, <span class="fu">lapply</span>(.SD, \(a) <span class="fu">grepl</span>(x, a))),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    .SDcols <span class="ot">=</span> cols</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  sb <span class="ot">&lt;-</span> SUBSTRATE[f1]</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Endolytic or Exolytic</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  ACTION <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'endolytic'</span>, <span class="st">'exolytic'</span>, <span class="st">'all'</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  action <span class="ot">&lt;-</span> ACTION[<span class="fu">pmatch</span>(action, ACTION)]</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (action <span class="sc">==</span> <span class="st">"endolytic"</span>) sb <span class="ot">&lt;-</span> sb[Endolytic <span class="sc">==</span> <span class="st">"Yes"</span>]</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (action <span class="sc">==</span> <span class="st">"exolytic"</span>) sb <span class="ot">&lt;-</span> sb[<span class="fu">is.na</span>(Endolytic)]</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CAZyme class</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(CAZyme_class, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  sb <span class="ot">&lt;-</span> sb[<span class="fu">sapply</span>(Family, \(x) <span class="fu">grepl</span>(p1, x))]</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Results</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EC"</span>     <span class="ot">=</span> <span class="fu">unwrap</span>(sb[, <span class="st">"EC_Number"</span>]),</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Family"</span> <span class="ot">=</span> <span class="fu">unwrap</span>(sb[, <span class="st">"Family"</span>]),</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Action"</span> <span class="ot">=</span> action</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>General function that takes EC (and CAZyme family) and outputs relevant tables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>findCAZymes <span class="ot">&lt;-</span> <span class="cf">function</span>(EC) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output should be a list of:</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. substrate from substrate table</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. hits from CAZYME</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. vector of latent bins split by habitat</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. vector of active bins split by habitat</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. matrix of genes with capacity split by habitat</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. matrix of transcripts split by habitat</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># EC can be a result from getCAZyBySubstrate or a vector of EC Numbers</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.list</span>(EC)) {</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    ec <span class="ot">&lt;-</span> EC<span class="sc">$</span>EC</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    fm <span class="ot">&lt;-</span> EC<span class="sc">$</span>Family</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    ec <span class="ot">&lt;-</span> EC</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  pool <span class="ot">&lt;-</span> <span class="fu">unwrap</span>(<span class="fu">c</span>(SUBSTRATE<span class="sc">$</span>EC_Number, CAZYME<span class="sc">$</span>EC))</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(ec <span class="sc">%in%</span> pool)) </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"EC numbers do not exist in mapping files. Please check."</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset substrates</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  dat1 <span class="ot">&lt;-</span> SUBSTRATE[EC_Number <span class="sc">%chin%</span> ec]</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset hit list</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'bin'</span>, <span class="st">'node'</span>, <span class="st">'dbcan_label'</span>, <span class="st">'tcdb_label'</span>, <span class="st">'sulfatlas_label'</span>,</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">'signalp_prediction'</span>, <span class="st">'transcription_regulation'</span>)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  dat2 <span class="ot">&lt;-</span> CAZYME[<span class="fu">sapply</span>(EC, \(x) <span class="fu">any</span>(x <span class="sc">%in%</span> ec))]</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  mags <span class="ot">&lt;-</span> ANNOTATION[node <span class="sc">%chin%</span> dat2<span class="sc">$</span>NODE, ..cols]</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  dat2 <span class="ot">&lt;-</span> dat2[mags, on <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NODE"</span> <span class="ot">=</span> <span class="st">"node"</span>)]</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Additional Family-based subset as required</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"fm"</span>)) {</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    dat1 <span class="ot">&lt;-</span> dat1[Family <span class="sc">%chin%</span> fm]</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    dat2 <span class="ot">&lt;-</span> dat2[FAMILY <span class="sc">%chin%</span> fm]</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gene and transcripts by habitat</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>  dat3 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(PARTITION, \(l) l[[<span class="st">"tpm"</span>]]) <span class="sc">%&gt;%</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapplyAtDepth</span>(<span class="dv">2</span>, \(m) {</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>      DT <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(m, <span class="at">keep.rownames =</span> <span class="st">"NODE"</span>)[dat2, on <span class="ot">=</span> <span class="st">"NODE"</span>]</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>      f <span class="ot">&lt;-</span> DT[, <span class="fu">rowSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(.SD)) <span class="sc">&gt;</span> <span class="dv">0</span>, .SDcols <span class="ot">=</span> <span class="fu">patterns</span>(<span class="st">"^Sed|^Filt"</span>)]</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>      DT[f]</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>      <span class="st">"substrates"</span> <span class="ot">=</span> dat1,</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>      <span class="st">"WGS"</span>        <span class="ot">=</span> <span class="fu">lapply</span>(dat3, \(l) l[[<span class="st">"WGS"</span>]]),</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>      <span class="st">"WTS"</span>        <span class="ot">=</span> <span class="fu">lapply</span>(dat3, \(l) l[[<span class="st">"WTS"</span>]])</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Corrected genome size from contig sizes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>calcGenomeSize <span class="ot">&lt;-</span> <span class="cf">function</span>(node2bin, checkm.stats) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Node required to extract information</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  contig.size <span class="ot">&lt;-</span> node2bin[</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">contig =</span> <span class="fu">gsub</span>(<span class="st">"(.*)_</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, node),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">".*_length_(</span><span class="sc">\\</span><span class="st">d+)_cov.*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, node)))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    , node <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  genome.size <span class="ot">&lt;-</span> contig.size[, .(<span class="at">size =</span> <span class="fu">sum</span>(size)), by <span class="ot">=</span> <span class="st">"bin"</span>]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  genome.size <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="fu">unique</span>(genome.size), checkm.stats, </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">by.x =</span> <span class="st">"bin"</span>, <span class="at">by.y =</span> <span class="st">"Rename"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  stats.cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Completeness"</span>, <span class="st">"Contamination"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  genome.size[</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">c</span>(stats.cols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, \(x) x<span class="sc">/</span><span class="dv">100</span>), </span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    .SDcols <span class="ot">=</span> stats.cols</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    , genome.size <span class="sc">:</span><span class="er">=</span> (size <span class="sc">/</span> Completeness) <span class="sc">-</span> (size <span class="sc">*</span> Contamination)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Proportions without <code>NA</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fProportions <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(x) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">/</span> <span class="fu">sum</span>(x)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="derived-data" class="level1">
<h1>Derived data</h1>
<section id="normalise-with-tpm" class="level2">
<h2 class="anchored" data-anchor-id="normalise-with-tpm">Normalise with TPM</h2>
<p>Derive <code>TPM</code> from <code>COUNTS</code> and <code>ANNOTATION</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>TPM <span class="ot">&lt;-</span> <span class="fu">lapply</span>(COUNTS, \(m) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sanity check</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  chk <span class="ot">&lt;-</span> <span class="fu">all</span>(ANNOTATION<span class="sc">$</span>node <span class="sc">==</span> <span class="fu">rownames</span>(m))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isFALSE</span>(chk)) <span class="fu">stop</span>(<span class="st">"Order matrices by node ID/check for missingness."</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  gene.length <span class="ot">&lt;-</span> ANNOTATION<span class="sc">$</span>end <span class="sc">-</span> ANNOTATION<span class="sc">$</span>start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(chk)) <span class="fu">calcTPM</span>(m, gene.length)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="presence-absence" class="level2">
<h2 class="anchored" data-anchor-id="presence-absence">Presence-absence</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>BINARY <span class="ot">&lt;-</span> <span class="fu">lapply</span>(COUNTS, \(m) <span class="fu">ifelse</span>(m <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="partition-data" class="level2">
<h2 class="anchored" data-anchor-id="partition-data">Partition data</h2>
<p>Count data partitioned according to habitat and subset to non-zero components. This facilitates propagation of analyses based on partitioned data. Partitioned data are:</p>
<ul>
<li>Raw counts</li>
<li>Binary</li>
<li>TPM</li>
</ul>
</section>
<section id="declare-habitat-type" class="level2 {callout-note}">
<h2 class="anchored" data-anchor-id="declare-habitat-type">Declare: Habitat type</h2>
<p>Habitat types are first created here.</p>
</section>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>habitat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"water"</span>, <span class="st">"sediment"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(habitat) <span class="ot">&lt;-</span> habitat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>PARTITION <span class="ot">&lt;-</span> <span class="fu">lapply</span>(habitat, \(s) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set pattern to select columns</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  pattern <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(s <span class="sc">==</span> <span class="st">"water"</span>, <span class="st">"Filt"</span>, <span class="st">"Sed"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Numeric data</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  numdata <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"COUNTS"</span>, <span class="st">"BINARY"</span>, <span class="st">"TPM"</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  NUMERIC_DATA <span class="ot">&lt;-</span> <span class="fu">lapplyAtDepth</span>(</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mget</span>(numdata, <span class="at">envir =</span> .GlobalEnv), <span class="dv">2</span>, \(l) <span class="fu">partMatrix</span>(l, pattern)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(NUMERIC_DATA) <span class="ot">&lt;-</span> <span class="fu">str_to_lower</span>(numdata)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  NUMERIC_DATA</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            used   (Mb) gc trigger   (Mb)  max used   (Mb)
Ncells   3185224  170.2    5304121  283.3   4431853  236.7
Vcells 240666744 1836.2  386924482 2952.0 386535783 2949.1</code></pre>
</div>
</div>
<section id="genome-size" class="level2">
<h2 class="anchored" data-anchor-id="genome-size">Genome size</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>GENOMESIZE <span class="ot">&lt;-</span> <span class="fu">calcGenomeSize</span>(ANNOTATION[, <span class="fu">c</span>(<span class="st">"node"</span>, <span class="st">"bin"</span>)], CHECKM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="general-statistics" class="level1">
<h1>General statistics</h1>
<ul>
<li>nMAG: Number of MAGs</li>
<li>nMAGCAZ: Number of MAGs with putative GH or PL</li>
<li>nCAZ: Number of GH or PL overall</li>
<li>nGP: Number of GH or PL families</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>genstat <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nMAG"</span> <span class="ot">=</span> <span class="fu">nrow</span>(TAXONOMY),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nMAGCAZ"</span> <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    ANNOTATION[<span class="fu">grepl</span>(<span class="st">"(GH|PL)"</span>, dbcan_label)]<span class="sc">$</span>bin</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  )),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nCAZ"</span> <span class="ot">=</span> <span class="fu">nrow</span>(ANNOTATION[<span class="fu">grepl</span>(<span class="st">"(GH|PL)"</span>, dbcan_label)]),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nGP"</span> <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">grep</span>(<span class="st">"(GH|PL)"</span>, CAZYME<span class="sc">$</span>FAMILY, <span class="at">value =</span> T)))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">mapply</span>(\(i, nm) <span class="fu">glue</span>(<span class="st">"{nm}: {i}"</span>), genstat, <span class="fu">names</span>(genstat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          nMAG        nMAGCAZ           nCAZ            nGP 
   "nMAG: 251" "nMAGCAZ: 251"   "nCAZ: 7156"     "nGP: 144" </code></pre>
</div>
</div>
<ul>
<li>Average GH or PL expression in each sample</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(PARTITION, \(l) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> l<span class="sc">$</span>tpm<span class="sc">$</span>WTS</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[<span class="fu">rownames</span>(m) <span class="sc">%in%</span> gp_node, ]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="fu">apply</span>(m, <span class="dv">2</span>, \(x) <span class="fu">mean</span>(x[x <span class="sc">&gt;</span> <span class="dv">0</span>])))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$water
Filt.S3_1 Filt.S7_1 Filt.S5_1 Filt.S9_1 Filt.S4_1 Filt.S8_1 Filt.S6_1 Filt.S2_1 
 3.292234  4.387929  4.660361  4.661090  4.930997  5.397994  5.746157  6.495118 
Filt.S1_1 
 6.750844 

$sediment
  Sed.S3_3   Sed.S3_2   Sed.S4_3   Sed.S5_2   Sed.S3_1   Sed.S5_1   Sed.S7_3 
  5.127279   5.193225   5.411861   6.588202   6.773164   7.078202   8.017090 
  Sed.S4_1   Sed.S4_2   Sed.S7_2   Sed.S2_1   Sed.S5_3   Sed.S7_1   Sed.S6_2 
  8.563135   8.733640   9.790756  11.642936  11.861069  15.738362  17.464085 
  Sed.S6_1   Sed.S2_2   Sed.S6_3   Sed.S2_3   Sed.S1_1   Sed.S1_3   Sed.S1_2 
 20.527951  21.985112  33.798940  34.079053  67.795045 114.914750 121.123396 </code></pre>
</div>
</div>
</section>
<section id="metatranscriptome-correlations" class="level1">
<h1>Metatranscriptome correlations</h1>
<ol type="1">
<li>Remove singletons and rank data</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>rank_TPM <span class="ot">&lt;-</span> <span class="fu">lapply</span>(PARTITION, \(l) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> l<span class="sc">$</span>tpm<span class="sc">$</span>WTS</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[<span class="fu">rowsums</span>(<span class="fu">ifelse</span>(m <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">&gt;</span> <span class="dv">1</span>, ]</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowRanks</span>(m)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Generate correlations</li>
</ol>
<blockquote class="blockquote">
<p>This part of the code is run on NeSI as a SLURM job to leverage the larger memory availability and multiple processors.</p>
</blockquote>
<p>The R code that is called in the job:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># Packages</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>library(Rfast)</span>
<span id="cb41-3"><a href="#cb41-3"></a>library(future.<span class="bu">apply</span>)</span>
<span id="cb41-4"><a href="#cb41-4"></a>library(data.table)</span>
<span id="cb41-5"><a href="#cb41-5"></a>library(purrr)</span>
<span id="cb41-6"><a href="#cb41-6"></a></span>
<span id="cb41-7"><a href="#cb41-7"></a><span class="co"># Set variables</span></span>
<span id="cb41-8"><a href="#cb41-8"></a>workers <span class="op">&lt;-</span> availableCores()</span>
<span id="cb41-9"><a href="#cb41-9"></a>args <span class="op">&lt;-</span> commandArgs(trailingOnly <span class="op">=</span> TRUE)</span>
<span id="cb41-10"><a href="#cb41-10"></a></span>
<span id="cb41-11"><a href="#cb41-11"></a><span class="co"># Import data</span></span>
<span id="cb41-12"><a href="#cb41-12"></a>matrix_list <span class="op">&lt;-</span> readRDS(args[<span class="dv">1</span>])</span>
<span id="cb41-13"><a href="#cb41-13"></a>cat(paste(<span class="st">"Imported"</span>, args[<span class="dv">1</span>]), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb41-14"><a href="#cb41-14"></a></span>
<span id="cb41-15"><a href="#cb41-15"></a><span class="co"># Function</span></span>
<span id="cb41-16"><a href="#cb41-16"></a>corPermMat2 <span class="op">&lt;-</span> function(mat, path, workers <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb41-17"><a href="#cb41-17"></a>                        k <span class="op">=</span> <span class="dv">999</span>, p.threshold <span class="op">=</span> <span class="dv">2</span>, rho.threshold <span class="op">=</span> <span class="dv">2</span>) {</span>
<span id="cb41-18"><a href="#cb41-18"></a>  <span class="co"># Initialise</span></span>
<span id="cb41-19"><a href="#cb41-19"></a>  <span class="cf">if</span> (workers <span class="op">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb41-20"><a href="#cb41-20"></a>    plan(multisession, workers <span class="op">=</span> workers)</span>
<span id="cb41-21"><a href="#cb41-21"></a>    cat(<span class="st">"Running with multisession futures</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb41-22"><a href="#cb41-22"></a>  } <span class="cf">else</span> {</span>
<span id="cb41-23"><a href="#cb41-23"></a>    plan(sequential)</span>
<span id="cb41-24"><a href="#cb41-24"></a>    cat(<span class="st">"Running with sequential futures</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb41-25"><a href="#cb41-25"></a>  }</span>
<span id="cb41-26"><a href="#cb41-26"></a>  </span>
<span id="cb41-27"><a href="#cb41-27"></a>  on.exit(plan(sequential))</span>
<span id="cb41-28"><a href="#cb41-28"></a>  </span>
<span id="cb41-29"><a href="#cb41-29"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="bu">dir</span>.exists(path)) <span class="bu">dir</span>.create(path, recursive <span class="op">=</span> TRUE)</span>
<span id="cb41-30"><a href="#cb41-30"></a>  cat(<span class="st">"Outputs are here:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb41-31"><a href="#cb41-31"></a>  cat(<span class="st">"  "</span>, path)</span>
<span id="cb41-32"><a href="#cb41-32"></a>  </span>
<span id="cb41-33"><a href="#cb41-33"></a>  nr <span class="op">&lt;-</span> nrow(mat)</span>
<span id="cb41-34"><a href="#cb41-34"></a>  </span>
<span id="cb41-35"><a href="#cb41-35"></a>  <span class="co"># Parallel correlations</span></span>
<span id="cb41-36"><a href="#cb41-36"></a>  future_lapply(seq_len(nr <span class="op">-</span> <span class="dv">1</span>), \(i) {</span>
<span id="cb41-37"><a href="#cb41-37"></a>    </span>
<span id="cb41-38"><a href="#cb41-38"></a>    <span class="co"># Output</span></span>
<span id="cb41-39"><a href="#cb41-39"></a>    pid <span class="op">&lt;-</span> Sys.getpid()</span>
<span id="cb41-40"><a href="#cb41-40"></a>    filename <span class="op">&lt;-</span> paste0(path, <span class="st">"/corPermMat2_output."</span>, pid, <span class="st">".csv"</span>)</span>
<span id="cb41-41"><a href="#cb41-41"></a>    </span>
<span id="cb41-42"><a href="#cb41-42"></a>    <span class="co"># Correlations</span></span>
<span id="cb41-43"><a href="#cb41-43"></a>    res <span class="op">&lt;-</span> lapply((i <span class="op">+</span> <span class="dv">1</span>):nr, \(j) {</span>
<span id="cb41-44"><a href="#cb41-44"></a>      </span>
<span id="cb41-45"><a href="#cb41-45"></a>      S <span class="op">&lt;-</span> permcor(mat[i, ], mat[j, ], k)</span>
<span id="cb41-46"><a href="#cb41-46"></a>      </span>
<span id="cb41-47"><a href="#cb41-47"></a>      <span class="cf">if</span> (<span class="bu">abs</span>(S[[<span class="dv">1</span>]]) <span class="op">&lt;</span> rho.threshold <span class="op">&amp;</span> S[[<span class="dv">2</span>]] <span class="op">&gt;</span> p.threshold) {</span>
<span id="cb41-48"><a href="#cb41-48"></a>        </span>
<span id="cb41-49"><a href="#cb41-49"></a>        S <span class="op">&lt;-</span> NULL</span>
<span id="cb41-50"><a href="#cb41-50"></a>        </span>
<span id="cb41-51"><a href="#cb41-51"></a>      } <span class="cf">else</span> {</span>
<span id="cb41-52"><a href="#cb41-52"></a>        </span>
<span id="cb41-53"><a href="#cb41-53"></a>        c(</span>
<span id="cb41-54"><a href="#cb41-54"></a>          <span class="st">"node1"</span>  <span class="op">=</span> rownames(mat)[i],</span>
<span id="cb41-55"><a href="#cb41-55"></a>          <span class="st">"node2"</span>  <span class="op">=</span> rownames(mat)[j],</span>
<span id="cb41-56"><a href="#cb41-56"></a>          <span class="st">"rho"</span>    <span class="op">=</span> S[[<span class="dv">1</span>]],</span>
<span id="cb41-57"><a href="#cb41-57"></a>          <span class="st">"perm.p"</span> <span class="op">=</span> S[[<span class="dv">2</span>]]</span>
<span id="cb41-58"><a href="#cb41-58"></a>        )</span>
<span id="cb41-59"><a href="#cb41-59"></a>        </span>
<span id="cb41-60"><a href="#cb41-60"></a>      }</span>
<span id="cb41-61"><a href="#cb41-61"></a>    </span>
<span id="cb41-62"><a href="#cb41-62"></a>    })</span>
<span id="cb41-63"><a href="#cb41-63"></a>    </span>
<span id="cb41-64"><a href="#cb41-64"></a>    <span class="co"># Convert list to data.table</span></span>
<span id="cb41-65"><a href="#cb41-65"></a>    res <span class="op">&lt;-</span> res[sapply(res, length) <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb41-66"><a href="#cb41-66"></a>    res_dt <span class="op">&lt;-</span> <span class="im">as</span>.data.table(list_transpose(res))</span>
<span id="cb41-67"><a href="#cb41-67"></a></span>
<span id="cb41-68"><a href="#cb41-68"></a>    <span class="co"># Progress message</span></span>
<span id="cb41-69"><a href="#cb41-69"></a>    <span class="cf">if</span> (i <span class="op">%%</span> <span class="dv">50</span> <span class="op">==</span> <span class="dv">0</span>) message(paste(i, <span class="st">"transcripts processed"</span>))</span>
<span id="cb41-70"><a href="#cb41-70"></a>    <span class="cf">if</span> (i <span class="op">==</span> nr <span class="op">-</span> <span class="dv">1</span>) message(<span class="st">"Completed"</span>)</span>
<span id="cb41-71"><a href="#cb41-71"></a>    </span>
<span id="cb41-72"><a href="#cb41-72"></a>    <span class="co"># Write output</span></span>
<span id="cb41-73"><a href="#cb41-73"></a>    fwrite(res_dt, <span class="bu">file</span> <span class="op">=</span> filename, append <span class="op">=</span> TRUE)</span>
<span id="cb41-74"><a href="#cb41-74"></a>    </span>
<span id="cb41-75"><a href="#cb41-75"></a>  }, future.seed <span class="op">=</span> TRUE, future.scheduling <span class="op">=</span> Inf)</span>
<span id="cb41-76"><a href="#cb41-76"></a>  </span>
<span id="cb41-77"><a href="#cb41-77"></a>}</span>
<span id="cb41-78"><a href="#cb41-78"></a></span>
<span id="cb41-79"><a href="#cb41-79"></a><span class="co"># Run</span></span>
<span id="cb41-80"><a href="#cb41-80"></a><span class="cf">for</span> (n <span class="kw">in</span> seq_len(length(matrix_list))) {</span>
<span id="cb41-81"><a href="#cb41-81"></a>  path <span class="op">&lt;-</span> paste0(getwd(), <span class="st">"/"</span>, names(matrix_list)[n])</span>
<span id="cb41-82"><a href="#cb41-82"></a>  corPermMat2(matrix_list[[n]], path <span class="op">=</span> path,</span>
<span id="cb41-83"><a href="#cb41-83"></a>              workers <span class="op">=</span> workers, p.threshold <span class="op">=</span> <span class="fl">0.05</span>)</span>
<span id="cb41-84"><a href="#cb41-84"></a>}</span>
<span id="cb41-85"><a href="#cb41-85"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The job submission:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a><span class="co">#!/bin/bash -e</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="co">#SBATCH --job-name=matpermcor</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="co">#SBATCH --account=uoa00348</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="co">#SBATCH --time=3-00:00:00</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="co">#SBATCH --mem=64G</span></span>
<span id="cb42-6"><a href="#cb42-6"></a><span class="co">#SBATCH --cpus-per-task=80</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="co">#SBATCH --partition=milan</span></span>
<span id="cb42-8"><a href="#cb42-8"></a><span class="co">#SBATCH --output=%x.%j.%A_%a.out</span></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="co">#SBATCH --error=%x.%j.%A_%a.err</span></span>
<span id="cb42-10"><a href="#cb42-10"></a></span>
<span id="cb42-11"><a href="#cb42-11"></a>module purge</span>
<span id="cb42-12"><a href="#cb42-12"></a>module load GSL<span class="op">/</span><span class="fl">2.7</span><span class="op">-</span>GCC<span class="op">-</span><span class="fl">12.3.0</span> R<span class="op">/</span><span class="fl">4.3.2</span><span class="op">-</span>foss<span class="op">-</span><span class="dv">2023</span><span class="er">a</span></span>
<span id="cb42-13"><a href="#cb42-13"></a></span>
<span id="cb42-14"><a href="#cb42-14"></a>Rscript matpermcor.R rank_TPM.rds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>(Safely) concatenate the results</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do this where the output directories are, not within</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>/<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">printf</span> <span class="st">"Processing %s\n"</span> <span class="va">$i</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set output per directory</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">outfile</span><span class="op">=</span>corPermMat2_output.<span class="st">"</span><span class="va">${i</span><span class="op">%%</span><span class="dt">\/</span><span class="va">}</span><span class="st">"</span>.csv</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;</span> <span class="st">"</span><span class="va">$outfile</span><span class="st">"</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">printf</span> <span class="st">"Outputs are here: %s\n"</span> <span class="va">$outfile</span> </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through CSV outputs per directory</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> j <span class="kw">in</span> <span class="va">${i}</span><span class="pp">*</span>.csv<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">printf</span> <span class="st">"Processing %s\n"</span> <span class="va">$j</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append header from first file if output file is empty</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-s</span> <span class="st">"</span><span class="va">$outfile</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">printf</span> <span class="st">"Appending header from %s\n"</span> <span class="va">$j</span> </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">head</span> <span class="at">-n</span> 1 <span class="va">$j</span> <span class="op">&gt;</span> <span class="va">$outfile</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append all other files to output</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tail</span> <span class="at">-n</span> +2 <span class="va">$j</span> <span class="op">&gt;&gt;</span> <span class="va">$outfile</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">done</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>Compress results and sync to R project directory</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load pigz rclone</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.csv<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pigz</span> <span class="at">-v</span> <span class="at">-p</span> 8 <span class="va">${i}</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">rclone</span> copy <span class="dt">\</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">${i}</span>.gz <span class="dt">\</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    jsboey_onedrive:Current\ Items/Projects/estuarine-CAZyme-diversity/data</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li>Backup scripts and compressed results to HPC project directory</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>csv.gz<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cp</span> <span class="va">${i}</span> /nesi/project/ga02676/Waiwera_project/boey_work/estuarine-CAZyme-diversity/data</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.<span class="dt">{R</span><span class="op">,</span><span class="dt">sl}</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cp</span> <span class="va">${i}</span> /nesi/project/ga02676/Waiwera_project/boey_work/estuarine-CAZyme-diversity/scripts</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="spatial-distribution-of-cazymes" class="level1">
<h1>Spatial distribution of CAZymes</h1>
<p>Distribution is divided according to:</p>
<ol type="1">
<li>Habitat (water column or sediment)</li>
<li>Salinity gradient (freshwater-brackish-marine)</li>
</ol>
<p>Results will be discussed according to habitats first, then according to salinity gradient.</p>
<section id="shared-cazymes-between-habitat-type" class="level2">
<h2 class="anchored" data-anchor-id="shared-cazymes-between-habitat-type">Shared CAZymes between habitat type</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>GP_in_habitat <span class="ot">&lt;-</span> <span class="fu">lapply</span>(PARTITION, \(l) l[<span class="st">"binary"</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>(<span class="at">recursive =</span> <span class="cn">FALSE</span>, <span class="at">use.names =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">list_transpose</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapplyAtDepth</span>(., <span class="dv">2</span>, \(m) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract CAZymes based on NODE matches</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unwrap</span>(CAZYME<span class="sc">$</span>FAMILY[CAZYME<span class="sc">$</span>NODE <span class="sc">%in%</span> <span class="fu">rownames</span>(m)]) <span class="sc">%&gt;%</span> </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grep</span>(<span class="st">"(GH|PL)"</span>, ., <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(., \(l) rlang<span class="sc">::</span><span class="fu">set_names</span>(l, \(s) <span class="fu">str_remove</span>(s, <span class="st">".binary"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Venn diagram of shared CAZyme latent potential.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>venn_all <span class="ot">&lt;-</span> <span class="fu">ggvenn</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  GP_in_habitat<span class="sc">$</span>WGS,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_color =</span> <span class="fu">c</span>(<span class="st">"#25A7F8"</span>, <span class="st">"#F89812"</span>), <span class="co"># For some reason, it doesn't take names.</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_alpha =</span> <span class="fl">0.5</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"WGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The CAZymes that are exclusive to sediment are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>sed_exclusive <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(setdiff, GP_in_habitat<span class="sc">$</span>WGS[<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>)]) <span class="sc">%&gt;%</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(., .)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>sed_exclusive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    GH8   GH164    GH48     PL3    PL39    GH87    GH66     PL4 
  "GH8" "GH164"  "GH48"   "PL3"  "PL39"  "GH87"  "GH66"   "PL4" </code></pre>
</div>
</div>
<p>The specific functions are putatively:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>sed_exclusive <span class="ot">&lt;-</span> <span class="fu">lapply</span>(sed_exclusive, \(s) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  pattern <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">b{s}</span><span class="sc">\\</span><span class="st">b"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(CAZYME)[<span class="fu">grepl</span>(pattern, FAMILY)]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>GH8</strong> : endo-1,4-beta-xylanase (3.2.1.8), chitosanase (3.2.1.132)</li>
<li><strong>GH164</strong>: beta-mannosidase (3.2.1.25)</li>
<li><strong>GH48</strong> : cellulase (3.2.1.4), reducing end cellulose 1,4-beta-cellobiosidase (3.2.1.176)</li>
<li><strong>PL3</strong> : pectate lyase (4.2.2.2)</li>
<li><strong>PL39</strong> : alginate lyase (4.2.2.-)</li>
<li><strong>GH87</strong> : (putative) endo-alpha-1,3-glucanase/alpha-1,3-1,4-glucanase (3.2.1.59/3.2.1.61)</li>
<li><strong>GH66</strong> : dextranase (3.2.1.11)</li>
<li><strong>PL4</strong> : rhamnogalacturonan endolyase (4.2.2.23)</li>
</ul>
<p>Venn diagram of transcribed vs genetically encoded CAZymes in each habitat type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>venn_water <span class="ot">&lt;-</span> <span class="fu">ggvenn</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">transpose</span>(GP_in_habitat)<span class="sc">$</span>water,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Water"</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>venn_sediment <span class="ot">&lt;-</span> <span class="fu">ggvenn</span>(</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">transpose</span>(GP_in_habitat)<span class="sc">$</span>sediment,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sediment"</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>venn_water <span class="sc">+</span> venn_sediment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/venn-wgs-wts-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cazyme-expression-across-habitats-and-salinity-gradient" class="level2">
<h2 class="anchored" data-anchor-id="cazyme-expression-across-habitats-and-salinity-gradient">CAZyme expression across habitats and salinity gradient</h2>
<p>TPM across a salinity gradient, faceted by habitat type</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert wide to long</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>TPM_long <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(TPM<span class="sc">$</span>WTS, <span class="at">keep.rownames =</span> <span class="st">"node"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(<span class="at">id.vars =</span> <span class="st">"node"</span>, <span class="at">variable.name =</span> <span class="st">"sample"</span>, <span class="at">value.name =</span> <span class="st">"tpm"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>TPM_long <span class="ot">&lt;-</span> TPM_long[</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove non-expressed</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  tpm <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge for salinity and type</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  METADATA[, .(sample, type, salinity)], on <span class="ot">=</span> <span class="st">"sample"</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print label</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  , label <span class="sc">:</span><span class="er">=</span> <span class="fu">paste0</span>(sample, <span class="st">" ("</span>, salinity, <span class="st">")"</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge for CAZyme families</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(CAZYME)[, .(NODE, FAMILY)], on <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"node"</span> <span class="ot">=</span> <span class="st">"NODE"</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset to GH and PL only</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grepl</span>(<span class="st">"(GH|PL)"</span>, FAMILY)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace for CAZyme class</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  , FAMILY <span class="sc">:</span><span class="er">=</span> <span class="fu">gsub</span>(<span class="st">".*(GH|PL).*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, FAMILY)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>TPM_long <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(TPM_long)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Factorise label</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>fct_TPM_long <span class="ot">&lt;-</span> <span class="fu">unique</span>(TPM_long[, .(label, type, salinity)]) <span class="sc">%&gt;%</span> </span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setorder</span>(., <span class="sc">-</span>type, salinity)</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>TPM_long <span class="ot">&lt;-</span> TPM_long[</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  , label <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(label, <span class="at">levels =</span> fct_TPM_long<span class="sc">$</span>label)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(TPM_long, <span class="fu">aes</span>(<span class="at">x =</span> salinity, <span class="at">y =</span> <span class="fu">log10</span>(tpm))) <span class="sc">+</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">span =</span> <span class="dv">1</span>, <span class="at">formula =</span> y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Sample (salinity in ppt)"</span>,</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"log10 TPM"</span>,</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"LOESS curves using all points (Î± = 1)"</span>) <span class="sc">+</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cazyme_colour) <span class="sc">+</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(FAMILY <span class="sc">~</span> type,</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">type =</span> str_to_title),</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>             <span class="at">space =</span> <span class="st">"free_x"</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: No shared levels found between `names(values)` of the manual scale and the
data's colour values.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-13-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="latent-and-realised-functional-potential" class="level2">
<h2 class="anchored" data-anchor-id="latent-and-realised-functional-potential">Latent and realised functional potential</h2>
<section id="beta-diversity" class="level3">
<h3 class="anchored" data-anchor-id="beta-diversity">Beta-diversity</h3>
<p><strong>Dimension reduction</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance matrix</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>DIST <span class="ot">&lt;-</span> <span class="fu">mget</span>(<span class="fu">c</span>(<span class="st">"BINARY"</span>, <span class="st">"TPM"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>(<span class="at">recursive =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapply</span>(\(m, nm) {</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset GH and PL nodes</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    node <span class="ot">&lt;-</span> CAZYME<span class="sc">$</span>NODE[<span class="fu">grep</span>(<span class="st">"(GH|PL)"</span>, CAZYME<span class="sc">$</span>FAMILY)]</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset matrix</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> m[<span class="fu">rowSums2</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">rownames</span>(m) <span class="sc">%in%</span> node,]</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set method</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    method <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"BINARY"</span>, nm), <span class="st">"jaccard"</span>, <span class="st">"bray"</span>)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate distance matrix</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vegdist</span>(<span class="fu">t</span>(m), <span class="at">method =</span> method)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  }, ., <span class="fu">names</span>(.))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Ordinations</strong></p>
<p><strong>Permutational Multivariate Analysis of Variance (PERMANOVA)</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>PERMANOVA <span class="ot">&lt;-</span> <span class="fu">lapply</span>(DIST, \(d) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset metadata</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> METADATA[sample <span class="sc">%in%</span> <span class="fu">attr</span>(d, <span class="st">"Labels"</span>), ]</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adonis2</span>(d <span class="sc">~</span> type <span class="sc">+</span> salinity, <span class="at">data =</span> data, <span class="at">by =</span> <span class="st">"margin"</span>, <span class="at">permutations =</span> <span class="dv">999</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Multivariate dispersion</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>BDISP <span class="ot">&lt;-</span> <span class="fu">lapply</span>(DIST, \(d) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset metadata</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> METADATA[sample <span class="sc">%in%</span> <span class="fu">attr</span>(d, <span class="st">"Labels"</span>), ]</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  disp <span class="ot">&lt;-</span><span class="fu">betadisper</span>(d, <span class="at">g =</span> data<span class="sc">$</span>type)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  sig <span class="ot">&lt;-</span> <span class="fu">permutest</span>(disp)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dispersion"</span> <span class="ot">=</span> disp,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p"</span> <span class="ot">=</span> sig</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="fu">mapply</span>(\(x, nm) <span class="fu">boxplot</span>(x<span class="sc">$</span>dispersion, <span class="at">main =</span> nm), BDISP, <span class="fu">names</span>(BDISP),</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/beta-dispersion-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/beta-dispersion-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/beta-dispersion-3.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/beta-dispersion-4.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$BINARY.WGS
$BINARY.WGS$stats
          [,1]      [,2]
[1,] 0.2839311 0.2281149
[2,] 0.3189413 0.2599069
[3,] 0.4532157 0.3246468
[4,] 0.5836019 0.3491837
[5,] 0.8184791 0.3491837

$BINARY.WGS$n
[1] 27  9

$BINARY.WGS$conf
          [,1]      [,2]
[1,] 0.3727400 0.2776277
[2,] 0.5336913 0.3716659

$BINARY.WGS$out
Filt.S1_1 Filt.S2_1 
0.6778504 0.6735711 

$BINARY.WGS$group
[1] 2 2

$BINARY.WGS$names
[1] "sediment" "water"   


$BINARY.WTS
$BINARY.WTS$stats
          [,1]      [,2]
[1,] 0.6070006 0.3264413
[2,] 0.6309754 0.3536583
[3,] 0.6632599 0.3713367
[4,] 0.6861532 0.4405801
[5,] 0.7092342 0.4405801

$BINARY.WTS$n
[1] 21  9

$BINARY.WTS$conf
          [,1]      [,2]
[1,] 0.6442355 0.3255579
[2,] 0.6822843 0.4171155

$BINARY.WTS$out
Filt.S1_1 Filt.S2_1 
0.7563019 0.7519093 

$BINARY.WTS$group
[1] 2 2

$BINARY.WTS$names
[1] "sediment" "water"   


$TPM.WGS
$TPM.WGS$stats
          [,1]      [,2]
[1,] 0.3270326 0.0754479
[2,] 0.3514397 0.1484169
[3,] 0.5366429 0.2367373
[4,] 0.6915183 0.3576075
[5,] 0.7955010 0.3576075

$TPM.WGS$n
[1] 27  9

$TPM.WGS$conf
          [,1]      [,2]
[1,] 0.4332348 0.1265636
[2,] 0.6400510 0.3469110

$TPM.WGS$out
Filt.S1_1 Filt.S2_1 
0.7969804 0.7893011 

$TPM.WGS$group
[1] 2 2

$TPM.WGS$names
[1] "sediment" "water"   


$TPM.WTS
$TPM.WTS$stats
          [,1]      [,2]
[1,] 0.5796050 0.2339155
[2,] 0.6089361 0.2782030
[3,] 0.6551208 0.3006000
[4,] 0.6789983 0.3882336
[5,] 0.7242119 0.3882336

$TPM.WTS$n
[1] 21  9

$TPM.WTS$conf
          [,1]      [,2]
[1,] 0.6309645 0.2426506
[2,] 0.6792772 0.3585495

$TPM.WTS$out
Filt.S1_1 Filt.S2_1 
0.8244810 0.8313061 

$TPM.WTS$group
[1] 2 2

$TPM.WTS$names
[1] "sediment" "water"   </code></pre>
</div>
</div>
<p><strong>Plot ordinations with stats</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>ordination <span class="ot">&lt;-</span> <span class="fu">mapply</span>(\(nmds, pv, nm) {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get coordinates &amp; environmental data</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  scr <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">scores</span>(nmds), <span class="at">keep.rownames =</span> <span class="st">"sample"</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  scr <span class="ot">&lt;-</span> METADATA[, .(sample, type, salinity)][<span class="fu">setDT</span>(scr), on <span class="ot">=</span> <span class="st">"sample"</span>]</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Format digits in PERMANOVA tables</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">format</span>(<span class="fu">round</span>(x, <span class="dv">2</span>), <span class="at">nsmall =</span> <span class="dv">3</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  pv2 <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(pv)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  pv2 <span class="ot">&lt;-</span> pv2[, <span class="fu">lapply</span>(.SD, f), .SDcols <span class="ot">=</span> <span class="fu">sapply</span>(pv, is.numeric)]</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  line_colour <span class="ot">&lt;-</span> <span class="st">"grey70"</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> scr, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> NMDS1, <span class="at">y =</span> NMDS2)) <span class="sc">+</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> line_colour) <span class="sc">+</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> line_colour) <span class="sc">+</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> salinity, <span class="at">shape =</span> type)) <span class="sc">+</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> nm,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> <span class="st">"Salinity (ppt)"</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> <span class="st">"Habitat type"</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> habitat_shape,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> str_to_title</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>  t1 <span class="ot">&lt;-</span> <span class="fu">tableGrob</span>(</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>    pv2, </span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">rows =</span> <span class="fu">rownames</span>(pv),</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">ttheme_default</span>(</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">base_size =</span> <span class="dv">8</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>  p1 <span class="sc">/</span> t1</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>}, NMDS, PERMANOVA, <span class="fu">names</span>(NMDS), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>ordination</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$BINARY.WGS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-nmds-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$BINARY.WTS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-nmds-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$TPM.WGS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-nmds-3.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$TPM.WTS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-nmds-4.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Plot beta dispersion test results</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>boxplot_bdisp <span class="ot">&lt;-</span> <span class="fu">mapply</span>(\(x, nm) {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> x<span class="sc">$</span>dispersion</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract distance</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">names</span>(data<span class="sc">$</span>distances),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">distance =</span> data<span class="sc">$</span>distances,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> data<span class="sc">$</span>group</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> dt) <span class="sc">+</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> group, <span class="at">y =</span> distance)) <span class="sc">+</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Habitat type"</span>,</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Dispersion"</span>,</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> nm,</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> x<span class="sc">$</span>p<span class="sc">$</span>tab[<span class="dv">1</span>, <span class="dv">6</span>]</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>}, BDISP, <span class="fu">names</span>(BDISP), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>boxplot_bdisp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$BINARY.WGS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/boxplot-beta-dispersion-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$BINARY.WTS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/boxplot-beta-dispersion-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$TPM.WGS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/boxplot-beta-dispersion-3.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$TPM.WTS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/boxplot-beta-dispersion-4.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Procrustes analyses</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>PROCRUSTES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BINARY"</span>, <span class="st">"TPM"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(., .)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>PROCRUSTES <span class="ot">&lt;-</span> <span class="fu">lapply</span>(PROCRUSTES, \(dtype) {</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset distances</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  dlist <span class="ot">&lt;-</span> DIST[<span class="fu">paste0</span>(dtype, <span class="st">"."</span>, srctype)] <span class="sc">%&gt;%</span> </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(., \(d) {</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(d)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> m[<span class="fu">rownames</span>(m) <span class="sc">%in%</span> overlap_samples, </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">colnames</span>(m) <span class="sc">%in%</span> overlap_samples]</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.dist</span>(m)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordinations</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  olist <span class="ot">&lt;-</span> <span class="fu">lapply</span>(dlist, metaMDS, <span class="at">k =</span> <span class="dv">2</span>, <span class="at">try =</span> <span class="dv">999</span>, <span class="at">trymax =</span> <span class="dv">5999</span>, <span class="at">trace =</span> <span class="dv">0</span>)</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">protest</span>(</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> olist[[<span class="dv">1</span>]], <span class="co"># Basis matrix </span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> olist[[<span class="dv">2</span>]]  <span class="co"># Rotated to basis matrix</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>PROCRUSTES</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$BINARY

Call:
protest(X = olist[[1]], Y = olist[[2]]) 

Procrustes Sum of Squares (m12 squared):        0.2464 
Correlation in a symmetric Procrustes rotation: 0.8681 
Significance:  0.001 

Permutation: free
Number of permutations: 999


$TPM

Call:
protest(X = olist[[1]], Y = olist[[2]]) 

Procrustes Sum of Squares (m12 squared):         0.11 
Correlation in a symmetric Procrustes rotation: 0.9434 
Significance:  0.001 

Permutation: free
Number of permutations: 999</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mapply</span>(\(l, nm) <span class="fu">plot</span>(l, <span class="at">main =</span> nm), PROCRUSTES, <span class="fu">names</span>(PROCRUSTES), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/procrustes-analysis-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$BINARY
$heads
                NMDS1        NMDS2
Filt.S1_1 -0.19702632 -0.172569353
Filt.S2_1 -0.19429298 -0.193382656
Filt.S3_1  0.02490863 -0.067711059
Filt.S4_1  0.05199458 -0.078057677
Filt.S5_1  0.05570774 -0.065590899
Filt.S6_1  0.03785439 -0.117884106
Filt.S7_1  0.04709913 -0.157133744
Filt.S8_1  0.03722344 -0.169580455
Filt.S9_1  0.06685793 -0.117018928
Sed.S1_1  -0.29927708  0.103033290
Sed.S1_2  -0.13898577  0.175883914
Sed.S1_3  -0.30149081 -0.016907400
Sed.S2_1  -0.25338904  0.044987155
Sed.S2_2  -0.26533758  0.061002827
Sed.S2_3  -0.28664135  0.043946069
Sed.S3_1   0.03877231  0.072121907
Sed.S3_2   0.03993220  0.078656683
Sed.S3_3   0.04556106  0.086474627
Sed.S4_1   0.07413142  0.065190985
Sed.S4_2   0.07304452  0.060265481
Sed.S4_3   0.08279911  0.060564171
Sed.S5_1   0.09083933  0.055483411
Sed.S5_2   0.09222502  0.046705197
Sed.S5_3   0.09202871  0.041504968
Sed.S6_1   0.10634475  0.049458251
Sed.S6_2   0.10432612  0.052547929
Sed.S6_3   0.09909273  0.053220493
Sed.S7_1   0.21863527  0.016208983
Sed.S7_2   0.22225985 -0.001515232
Sed.S7_3   0.23480268 -0.009904831

$points
                  [,1]        [,2]
Filt.S1_1 -0.100057186 -0.19959264
Filt.S2_1 -0.093766452 -0.17136706
Filt.S3_1 -0.012010824 -0.14643029
Filt.S4_1  0.009892085 -0.14864524
Filt.S5_1  0.023518873 -0.11597045
Filt.S6_1 -0.013617584 -0.18549990
Filt.S7_1  0.004162425 -0.19227016
Filt.S8_1  0.038469632 -0.21073756
Filt.S9_1  0.054976735 -0.15040507
Sed.S1_1  -0.199527360  0.06041017
Sed.S1_2  -0.181046936  0.09759617
Sed.S1_3  -0.158400709  0.21086734
Sed.S2_1  -0.087780315  0.01854330
Sed.S2_2  -0.240912907  0.06299572
Sed.S2_3  -0.193900345  0.08334529
Sed.S3_1   0.031413743  0.02235313
Sed.S3_2   0.031892075  0.04775298
Sed.S3_3   0.007366627  0.05808405
Sed.S4_1   0.074680993  0.06360700
Sed.S4_2   0.074793026  0.03910152
Sed.S4_3   0.060095411  0.04677615
Sed.S5_1   0.091993209  0.05986313
Sed.S5_2   0.094438912  0.03775852
Sed.S5_3   0.060153433  0.08174298
Sed.S6_1   0.093859863  0.09413585
Sed.S6_2   0.039648421  0.12611441
Sed.S6_3   0.076825277  0.15276398
Sed.S7_1   0.129255109  0.07656181
Sed.S7_2   0.148362964  0.06071093
Sed.S7_3   0.135221805  0.01983391

attr(,"class")
[1] "ordiplot"

$TPM
$heads
                NMDS1       NMDS2
Filt.S1_1 -0.26283036 -0.10443140
Filt.S2_1 -0.26097531 -0.11211158
Filt.S3_1 -0.10140188 -0.11152055
Filt.S4_1 -0.06175495 -0.12540376
Filt.S5_1 -0.03969504 -0.12937432
Filt.S6_1 -0.07264707 -0.14376142
Filt.S7_1 -0.05510512 -0.20582033
Filt.S8_1 -0.05321399 -0.21353200
Filt.S9_1 -0.02277070 -0.19089252
Sed.S1_1  -0.17756263  0.14912879
Sed.S1_2  -0.05260432  0.13613982
Sed.S1_3  -0.22381676  0.17065507
Sed.S2_1  -0.15666674  0.13604118
Sed.S2_2  -0.15952159  0.16374003
Sed.S2_3  -0.18506443  0.12749593
Sed.S3_1   0.07672154  0.09951450
Sed.S3_2   0.07837514  0.11736025
Sed.S3_3   0.07053199  0.11342343
Sed.S4_1   0.11661875  0.05671841
Sed.S4_2   0.10877728  0.05221214
Sed.S4_3   0.10241895  0.04947304
Sed.S5_1   0.12309986  0.03674713
Sed.S5_2   0.12064517  0.02775992
Sed.S5_3   0.11376214  0.01917605
Sed.S6_1   0.12996942  0.02323928
Sed.S6_2   0.13670916  0.02703397
Sed.S6_3   0.12586649  0.02201722
Sed.S7_1   0.18823895 -0.04788826
Sed.S7_2   0.19417921 -0.06170722
Sed.S7_3   0.19971685 -0.08143281

$points
                 [,1]         [,2]
Filt.S1_1 -0.20457953 -0.110117471
Filt.S2_1 -0.19052513 -0.099420617
Filt.S3_1 -0.11246506 -0.150729663
Filt.S4_1 -0.08547221 -0.162121514
Filt.S5_1 -0.07006247 -0.152129410
Filt.S6_1 -0.07991676 -0.169838872
Filt.S7_1 -0.04125774 -0.207427978
Filt.S8_1 -0.03979353 -0.210352419
Filt.S9_1 -0.04044935 -0.198468905
Sed.S1_1  -0.16143949  0.098117157
Sed.S1_2  -0.15731985  0.143222899
Sed.S1_3  -0.08758937  0.270065537
Sed.S2_1  -0.07500587  0.119584087
Sed.S2_2  -0.19337499  0.129467378
Sed.S2_3  -0.13250599  0.141267755
Sed.S3_1   0.07349449  0.048549527
Sed.S3_2   0.07635130  0.079538642
Sed.S3_3   0.04539910  0.108167168
Sed.S4_1   0.10131986  0.053746252
Sed.S4_2   0.10378561  0.029679914
Sed.S4_3   0.12694566  0.054203344
Sed.S5_1   0.11444138  0.042466766
Sed.S5_2   0.10503979  0.010906512
Sed.S5_3   0.08817741  0.075404011
Sed.S6_1   0.15030636  0.039091246
Sed.S6_2   0.12345808  0.108652825
Sed.S6_3   0.16807902 -0.020978660
Sed.S7_1   0.15986603  0.002019209
Sed.S7_2   0.12426347 -0.036172443
Sed.S7_3   0.11082978 -0.036392277

attr(,"class")
[1] "ordiplot"</code></pre>
</div>
</div>
<p><strong>Procrustes distance analyses</strong></p>
<p>The linear models tested are:</p>
<ul>
<li><strong>A</strong>: All samples</li>
<li><strong>B</strong>: Outlier removed</li>
<li><strong>C</strong>: Outlier and brackish removed</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gather Procrustes results</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>PROCSCR <span class="ot">&lt;-</span> <span class="fu">lapply</span>(PROCRUSTES, \(l) {</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(l[[<span class="st">"X"</span>]], l[[<span class="st">"Yrot"</span>]], <span class="fu">residuals</span>(l)), </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">keep.rownames =</span> <span class="st">"sample"</span>)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(df)[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"XNMDS1"</span>, <span class="st">"XNMDS2"</span>, <span class="st">"YrNMDS1"</span>, <span class="st">"YrNMDS2"</span>, <span class="st">"residuals"</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  METADATA[, .(sample, type, salinity)][df, on <span class="ot">=</span> <span class="st">"sample"</span>]</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear models</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="co"># (A) All samples</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="co"># (B) Outlier removed (Outlier defined as &gt; Q3 + 1.5 IQR)</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co"># (C) (B) &amp; Brackish samples removed</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>lmPROCSCR <span class="ot">&lt;-</span> <span class="fu">lapply</span>(PROCSCR, \(df) {</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data for model A</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> df</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data for model B</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>  outlier_threshold <span class="ot">&lt;-</span> <span class="fu">quantile</span>(df<span class="sc">$</span>residuals, <span class="fl">0.75</span>) <span class="sc">+</span> (<span class="fl">1.5</span> <span class="sc">*</span> <span class="fu">IQR</span>(df<span class="sc">$</span>residuals))</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> df[residuals <span class="sc">&lt;</span> outlier_threshold]</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data for model C</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  brackish_pattern <span class="ot">&lt;-</span> <span class="st">"S3"</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> B[<span class="sc">!</span><span class="fu">grepl</span>(brackish_pattern, sample)]</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set formulae</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Habitat"</span> <span class="ot">=</span> <span class="fu">formula</span>(residuals <span class="sc">~</span> type),</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Salinity"</span> <span class="ot">=</span> <span class="fu">formula</span>(residuals <span class="sc">~</span> salinity)</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gather data frames</span></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  df.list <span class="ot">&lt;-</span> <span class="fu">mget</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>  output1 <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="st">"formula"</span> <span class="ot">=</span> f, <span class="st">"data"</span> <span class="ot">=</span> df.list)</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>  output2 <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"variable.spec"</span> <span class="ot">=</span> <span class="fu">names</span>(f), </span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model.spec"</span> <span class="ot">=</span> <span class="fu">names</span>(df.list)</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">cbind</span>(output2, output1)</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setDT</span>(output)[</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear models and Spearman correlations</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>.N, \(i) <span class="fu">lm</span>(formula[[i]], data[[i]])),</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>.N, \(i) {</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>        data[[i]] <span class="sc">%$%</span> </span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cor.test</span>(residuals, salinity, <span class="at">method =</span> <span class="st">"spearman"</span>)</span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model coefficients and variable significance</span></span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>    , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">coeffs =</span> <span class="fu">lapply</span>(model, coef),</span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">varsig =</span> <span class="fu">lapply</span>(model, anova)</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties

Warning in cor.test.default(residuals, salinity, method = "spearman"): Cannot
compute exact p-value with ties</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>lmPROCSCR_result <span class="ot">&lt;-</span> <span class="fu">lapply</span>(lmPROCSCR, \(dt) {</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  dt[</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">n          =</span> <span class="fu">sapply</span>(data, nrow),</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable   =</span> <span class="fu">sapply</span>(formula, \(x) <span class="fu">as.character</span>(x)[<span class="dv">3</span>]),</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept  =</span> <span class="fu">sapply</span>(coeffs, \(x) x[<span class="dv">1</span>]),</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">slope      =</span> <span class="fu">sapply</span>(coeffs, \(x) x[<span class="dv">2</span>]),</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable.p =</span> <span class="fu">sapply</span>(varsig, \(x) x[<span class="dv">1</span>, <span class="fu">ncol</span>(x)]),</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">r2         =</span> <span class="fu">sapply</span>(model, \(x) <span class="fu">summary</span>(x)<span class="sc">$</span>adj.r.squared),</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">rho        =</span> <span class="fu">sapply</span>(correlation, \(x) x[[<span class="st">"estimate"</span>]]),</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">rho.p      =</span> <span class="fu">sapply</span>(correlation, \(x) x<span class="sc">$</span>p.value)</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retain relevant columns</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    , .SD, .SDcols <span class="ot">=</span> <span class="fu">sapply</span>(dt, \(x) <span class="sc">!</span><span class="fu">is.list</span>(x))</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Plot Procrustes ordination</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>ordination_proc <span class="ot">&lt;-</span> <span class="fu">mapply</span>(\(dt, proc, nm) {</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract slopes for rotational guides</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  rot <span class="ot">&lt;-</span> proc<span class="sc">$</span>rotation</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  rot_m <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> <span class="dv">2</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(rot))) {</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    rot_m[i] <span class="ot">&lt;-</span> rot[i, <span class="dv">2</span>]<span class="sc">/</span>rot[i, <span class="dv">1</span>]</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  rot_lines <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope =</span> rot_m</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  line_colour <span class="ot">&lt;-</span> <span class="st">"grey70"</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>  segment_colour <span class="ot">&lt;-</span> <span class="st">"cornflowerblue"</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordination</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">colour =</span> line_colour) <span class="sc">+</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">colour =</span> line_colour) <span class="sc">+</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> rot_lines,</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">intercept =</span> intercept,</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">slope =</span> slope</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> line_colour</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dt,</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> XNMDS1,</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> XNMDS2,</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">xend =</span> YrNMDS1,</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">yend =</span> YrNMDS2</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> <span class="fu">arrow</span>(</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">angle =</span> <span class="dv">30</span>,</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">length =</span> <span class="fu">unit</span>(<span class="dv">3</span>, <span class="st">"points"</span>)</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> segment_colour</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dt,</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> XNMDS1,</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> XNMDS2,</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> salinity,</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> type</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> nm,</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"NMDS1"</span>,</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"NMDS2"</span>,</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> <span class="st">"Salinity (ppt)"</span>,</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> <span class="st">"Habitat type"</span> </span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> habitat_shape,</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> str_to_title</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">aspect.ratio =</span> <span class="dv">1</span>,</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a>}, PROCSCR, PROCRUSTES, <span class="fu">names</span>(PROCSCR), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(ordination_proc, <span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span></span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-procrustes-ordination-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Plot Procrustes residual analysis results</strong></p>
<p>Remove Habitat models and model C prior to plotting fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>scatter_proclm <span class="ot">&lt;-</span> <span class="fu">mapply</span>(\(dtPoint, dtLine, nm) {</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  dtLine <span class="ot">&lt;-</span> dtLine[variable.spec <span class="sc">!=</span> <span class="st">"Habitat"</span> <span class="sc">&amp;</span> model.spec <span class="sc">!=</span> <span class="st">"C"</span>]</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  labels_lty <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"All samples (n = "</span>, <span class="st">"Outlier removed (n = "</span>), </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    dtLine<span class="sc">$</span>n,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="st">")"</span>, <span class="at">times =</span> <span class="dv">2</span>)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  bounds <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dtPoint<span class="sc">$</span>residuals, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>))</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">geom =</span> <span class="st">"rect"</span>,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmin =</span> <span class="sc">-</span><span class="cn">Inf</span>,</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmax =</span> <span class="cn">Inf</span>,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> bounds[<span class="dv">1</span>],</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> bounds[<span class="dv">2</span>],</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"grey80"</span>,</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dtPoint,</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> salinity,</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> residuals,</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> type,</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> type</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dtLine,</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">intercept =</span> intercept,</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">slope =</span> slope,</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> model.spec</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> nm,</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Salinity (ppt)"</span>,</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Procrustes residuals"</span>,</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> <span class="st">"Habitat type"</span>,</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">"Data subset"</span></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.3</span>)</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> habitat_colour,</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> str_to_title</span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> habitat_shape,</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> str_to_title</span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(</span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dashed"</span>, <span class="st">"twodash"</span>),</span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> labels_lty</span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a>}, PROCSCR, lmPROCSCR_result, <span class="fu">names</span>(PROCSCR), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(scatter_proclm, <span class="at">guides =</span> <span class="st">'collect'</span>) <span class="sc">&amp;</span></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-lm-procrustes-residuals-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="log-ratio-analyses" class="level4">
<h4 class="anchored" data-anchor-id="log-ratio-analyses">Log-ratio analyses</h4>
<p>Linear model analyses of Procrustes residuals show</p>
<ol type="1">
<li>Increased coupling between latent and realised functional potentials with increasing salinity</li>
<li>Strong decoupling in a few non-saline sediment samples</li>
</ol>
<p>This analysis aims to determine:</p>
<ol type="1">
<li>General patterns in direct analyses of the gene/transcript difference</li>
<li>Potential GH or PL encoding genes/transcripts that may have led to this decoupling</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>WTSdiffWGS <span class="ot">&lt;-</span> <span class="fu">lapply</span>(TPM, \(m) {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[<span class="fu">rownames</span>(m) <span class="sc">%in%</span> gp_node, <span class="fu">colnames</span>(m) <span class="sc">%in%</span> overlap_samples]</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  m[<span class="fu">rowSums2</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span>, ]</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    \(wgs, wts) <span class="fu">calcMatrixDiff</span>(wgs, wts, <span class="at">method =</span> <span class="st">"ratio"</span>, <span class="at">log =</span> <span class="cn">TRUE</span>, <span class="at">base =</span> <span class="dv">2</span>), .</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(., \(delta) <span class="fu">as.data.table</span>(delta, <span class="at">keep.rownames =</span> <span class="st">"node"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(., <span class="at">idcol =</span> <span class="st">"sample"</span>)</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>WTSdiffWGS <span class="ot">&lt;-</span> METADATA[, .(sample, type, salinity)][</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  WTSdiffWGS, on <span class="ot">=</span> <span class="st">"sample"</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(WTSdiffWGS) <span class="sc">+</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> salinity, <span class="at">y =</span> delta)) <span class="sc">+</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Salinity (ppt)"</span>, </span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Transcript : Gene TPM"</span>) <span class="sc">+</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(. <span class="sc">~</span> type, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">type =</span> str_to_title)) <span class="sc">+</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/log-ratio-wts-wgs-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>While there are some big discrepancies in WTS/WGS ratios, it is unlikely that those genes/transcripts are driving the Procrustes residuals. Based on the observations on the Procrustes residuals from BINARY data, the genes/transcripts that are likely driving the Procrustes residuals might benefit from identification via binary analysis.</p>
</section>
<section id="binary-transcriptgene-analyses" class="level4">
<h4 class="anchored" data-anchor-id="binary-transcriptgene-analyses">Binary transcript/gene analyses</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>WTSjaccardWGS <span class="ot">&lt;-</span> <span class="fu">lapply</span>(BINARY, \(m) {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[<span class="fu">rownames</span>(m) <span class="sc">%in%</span> gp_node, <span class="fu">colnames</span>(m) <span class="sc">%in%</span> overlap_samples]</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  m[<span class="fu">rowSums2</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span>, ]</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(\(wgs, wts) <span class="fu">calcMatrixJaccard</span>(wgs, wts),. )</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>WTSjaccardWGS <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample =</span> <span class="fu">names</span>(WTSjaccardWGS),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">jaccard =</span> <span class="fu">sapply</span>(WTSjaccardWGS, \(x) <span class="fu">as.vector</span>(x))</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>WTSjaccardWGS <span class="ot">&lt;-</span> METADATA[, .(sample, type, salinity)][</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  WTSjaccardWGS, on <span class="ot">=</span> <span class="st">"sample"</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(WTSjaccardWGS) <span class="sc">+</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> salinity, <span class="at">y =</span> jaccard, <span class="at">label =</span> sample)) <span class="sc">+</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(. <span class="sc">~</span> type, <span class="at">space =</span> <span class="st">"free_x"</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/jaccard-wts-wgs-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="alpha-diversity" class="level3">
<h3 class="anchored" data-anchor-id="alpha-diversity">Alpha-diversity</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>ADIV <span class="ot">&lt;-</span> <span class="fu">lapply</span>(TPM, \(m) {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[<span class="fu">rowSums2</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">rownames</span>(m) <span class="sc">%in%</span> gp_node, ]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample"</span>   <span class="ot">=</span> <span class="fu">colnames</span>(m),</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"richness"</span> <span class="ot">=</span> <span class="fu">specnumber</span>(m, <span class="at">MARGIN =</span> <span class="dv">2</span>),</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"simpsons"</span> <span class="ot">=</span> <span class="fu">diversity</span>(m, <span class="at">index =</span> <span class="st">"invsimpson"</span>, <span class="at">MARGIN =</span> <span class="dv">2</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(<span class="at">idcol =</span> <span class="st">"srctype"</span>)</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with metadata and derive evenness </span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>ADIV <span class="ot">&lt;-</span> METADATA[</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  , .(sample, salinity, type)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  ADIV, on <span class="ot">=</span> <span class="st">"sample"</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  , evenness <span class="sc">:</span><span class="er">=</span> simpsons<span class="sc">/</span>richness</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">melt</span>(</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  ADIV,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">id.vars =</span> <span class="fu">c</span>(<span class="st">"sample"</span>, <span class="st">"srctype"</span>, <span class="st">"type"</span>, <span class="st">"salinity"</span>),</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"richness"</span>, <span class="st">"simpsons"</span>, <span class="st">"evenness"</span>),</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable.name =</span> <span class="st">"index"</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">value.name =</span> <span class="st">"value"</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> salinity,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> value,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">colour =</span> type)) <span class="sc">+</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> F, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">span =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Salinity (ppt)"</span>,</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">"Habitat type"</span>) <span class="sc">+</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> habitat_colour,</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> str_to_title) <span class="sc">+</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    srctype <span class="sc">~</span> index, </span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>, </span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">labeller</span>(</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">index =</span> <span class="fu">c</span>(</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"richness"</span> <span class="ot">=</span> <span class="st">"Richness"</span>,</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"simpsons"</span> <span class="ot">=</span> <span class="st">"Simpson's diversity (1/Î»)"</span>,</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"evenness"</span> <span class="ot">=</span> <span class="st">"Simpson's evenness"</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">srctype =</span> <span class="fu">c</span>(</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"WGS"</span> <span class="ot">=</span> <span class="st">"Gene"</span>, </span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"WTS"</span> <span class="ot">=</span> <span class="st">"Transcript"</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in melt.data.table(ADIV, id.vars = c("sample", "srctype", "type", :
'measure.vars' [richness, simpsons, evenness, ...] are not all of the same
type. By order of hierarchy, the molten data value column will be of type
'double'. All measure variables not of type 'double' will be coerced too. Check
DETAILS in ?melt.data.table for more on coercion.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/plot-alpha-diversity-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="numerical-properties-of-cazyme-genes-and-transcripts" class="level2">
<h2 class="anchored" data-anchor-id="numerical-properties-of-cazyme-genes-and-transcripts">Numerical properties of CAZyme genes and transcripts</h2>
<p><strong>Proportion of transcripts for CAZymes vs other metabolic functions</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>proportion_CAZyme <span class="ot">&lt;-</span> <span class="fu">lapply</span>(COUNTS, \(m) {</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create proportions table</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  pm <span class="ot">&lt;-</span> <span class="fu">proportions</span>(m, <span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(pm, <span class="at">keep.rownames =</span> <span class="st">"node"</span>)</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>(dt[node <span class="sc">%in%</span> gp_node][, <span class="at">node :=</span> <span class="cn">NULL</span>]) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Distribution properties of CAZyme normalised gene and transcript counts</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>gp_TPM <span class="ot">&lt;-</span> <span class="fu">lapply</span>(TPM, \(m) {</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> m[<span class="fu">rownames</span>(m) <span class="sc">%in%</span> gp_node, <span class="fu">colnames</span>(m) <span class="sc">%in%</span> overlap_samples]</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(m, <span class="at">keep.rownames =</span> <span class="st">"node"</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">melt</span>(DT, </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">measure =</span> <span class="fu">patterns</span>(<span class="st">"^(Sed|Filt)"</span>),</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">variable.name =</span> <span class="st">"sample"</span>, <span class="at">value.name =</span> <span class="st">"tpm"</span>)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  METADATA[, .(sample, type, salinity)][DT, on <span class="ot">=</span> <span class="st">"sample"</span>]</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(<span class="at">idcol =</span> <span class="st">"srctype"</span>)</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gp_TPM[tpm <span class="sc">&gt;</span> <span class="dv">0</span>]) <span class="sc">+</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">log2</span>(tpm),</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> srctype,</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(sample <span class="sc">~</span> ., <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"TPM-normalised Count (Log-scale)"</span>,</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Data type"</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/distribution-cazyme-tpm-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dcast</span>(gp_TPM, ... <span class="sc">~</span> srctype, <span class="at">value.var =</span> <span class="st">"tpm"</span>)[WGS <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> WTS <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">log2</span>(WGS),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log2</span>(WTS)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> sample) <span class="sc">+</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Gene count (per million, log2 scaled)"</span>,</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Transcript count (per million, log2 scaled)"</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/distribution-cazyme-tpm-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="thresholding-for-binary-analysis" class="level1">
<h1>Thresholding for binary analysis</h1>
<p>For presence/absence | transcriptionally active/dormant type analysis, there needs to be some thresholding to determine what counts as present/active.</p>
<section id="bin-presence" class="level2">
<h2 class="anchored" data-anchor-id="bin-presence">Bin presence</h2>
<p>To determine presence, I will use coverage breadth (i.e., number of bases covered by reads relative to the total contig size of a bin)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>calcBinBaseCov <span class="ot">&lt;-</span> <span class="cf">function</span>(contig.coverage, node2bin) {</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Format contig-bin mapping</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  contig2bin <span class="ot">&lt;-</span> node2bin[</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    , contig <span class="sc">:</span><span class="er">=</span> <span class="fu">gsub</span>(<span class="st">"(.*)_</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, node)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    , node <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  ] <span class="sc">%&gt;%</span> </span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>()</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add attributes to data table</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  coverage <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(contig.coverage, <span class="at">keep.rownames =</span> <span class="st">"contig"</span>)[</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    , total.size <span class="sc">:</span><span class="er">=</span> <span class="fu">attr</span>(contig.coverage, <span class="st">"contig.length"</span>)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge data and summarise</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cols_req &lt;- c("total.size", colnames(contig.coverage))</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(contig2bin, coverage, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">by =</span> <span class="st">"contig"</span>)[</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">lapply</span>(.SD, \(x) <span class="fu">sum</span>(x) <span class="sc">/</span> <span class="fu">sum</span>(total.size)), </span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"bin"</span>, .SDcols <span class="ot">=</span> <span class="fu">colnames</span>(contig.coverage)</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>bin_bcov <span class="ot">&lt;-</span> <span class="fu">calcBinBaseCov</span>(</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  CONTIGMAP<span class="sc">$</span>WGS.basecov, ANNOTATION[, <span class="fu">c</span>(<span class="st">"bin"</span>, <span class="st">"node"</span>)]</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(<span class="at">rownames =</span> <span class="st">"bin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Iâ€™ll use Emilieâ€™s cutoff at 10% coverage breadth</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply cutoff</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>MAG_present <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bin_bcov <span class="sc">&lt;</span> <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative frequency</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>xlim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bin_bcov), <span class="fu">max</span>(bin_bcov))</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>ylim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(bin_bcov))</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim =</span> xlim, <span class="at">ylim =</span> ylim, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Cumulative number of MAGs"</span>, <span class="at">xlab =</span> <span class="st">"MAG coverage breadth"</span>)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(bin_bcov)) {</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>  color <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, <span class="fu">colnames</span>(bin_bcov)[j]), <span class="st">"cornflowerblue"</span>, <span class="st">"firebrick2"</span>)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">sort</span>(bin_bcov[, j])</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>  br <span class="ot">&lt;-</span> <span class="fu">pretty</span>(x, <span class="at">n =</span> <span class="dv">25</span>)</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">table</span>(<span class="fu">cut</span>(x, br)))</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">0</span>, cf) <span class="sc">~</span> br, <span class="at">col =</span> color)</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fl">0.1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(xlim, ylim, j, color, x, br, cf)</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">colSums</span>(MAG_present),</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, <span class="fu">colnames</span>(bin_bcov)), </span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"cornflowerblue"</span>, <span class="st">"firebrick2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/bin-present-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I suppose I expected this, there werenâ€™t that many reads for non-saline sediment to begin with anywayâ€¦</p>
</section>
<section id="bin-active" class="level2">
<h2 class="anchored" data-anchor-id="bin-active">Bin active</h2>
<p>Emilie also used a coverage breadth threshold of 10% for transcripts, letâ€™s see how that holds up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>bin_tcov <span class="ot">&lt;-</span> <span class="fu">calcBinBaseCov</span>(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  CONTIGMAP<span class="sc">$</span>WTS.basecov, ANNOTATION[, <span class="fu">c</span>(<span class="st">"bin"</span>, <span class="st">"node"</span>)]</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(<span class="at">rownames =</span> <span class="st">"bin"</span>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative frequency</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>xlim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bin_tcov), <span class="fu">max</span>(bin_tcov))</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>ylim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(bin_tcov))</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim =</span> xlim, <span class="at">ylim =</span> ylim, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Cumulative number of MAGs"</span>, <span class="at">xlab =</span> <span class="st">"MAG transcript coverage breadth"</span>)</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(bin_tcov)) {</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>  color <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, <span class="fu">colnames</span>(bin_tcov)[j]), <span class="st">"cornflowerblue"</span>, <span class="st">"firebrick2"</span>)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">sort</span>(bin_tcov[, j])</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  br <span class="ot">&lt;-</span> <span class="fu">pretty</span>(x, <span class="at">n =</span> <span class="dv">25</span>)</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">table</span>(<span class="fu">cut</span>(x, br)))</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">0</span>, cf) <span class="sc">~</span> br, <span class="at">col =</span> color)</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fl">0.1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(xlim, ylim, j, color, x, br, cf)</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">colSums</span>(bin_tcov <span class="sc">&gt;=</span> <span class="fl">0.1</span>), </span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, <span class="fu">colnames</span>(bin_tcov)), </span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"cornflowerblue"</span>, <span class="st">"firebrick2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/transcript-cov-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Yikesâ€¦ Pretty much no bins left in sedimentâ€¦ I wonder, which bin is hoarding all the transcripts in those environments? Thereâ€™s also relative actvity which I can use to compare values to.</p>
<p><span class="math display">\[
\textrm{MAG relative activity} =
\frac{
  \textrm{Transcripts mapped to MAG}
}{
  \textrm{Total metatranscriptomic reads}
} \times
\frac{
  \textrm{Total metagenome size}
}{
  \textrm{MAG size}
}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define relative activity</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>calcRelativeActivity <span class="ot">&lt;-</span> <span class="cf">function</span>(count, genome.size, bin2node) {</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scaling factor: genome to metagenome size</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  genome.size <span class="ot">&lt;-</span> <span class="fu">set_names</span>(genome.size<span class="sc">$</span>genome.size, genome.size<span class="sc">$</span>bin)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  metagenome.size <span class="ot">&lt;-</span> <span class="fu">sum</span>(genome.size)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  scaling <span class="ot">&lt;-</span> metagenome.size <span class="sc">/</span> genome.size</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Per MAG transcript proportions</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(bin2node, <span class="fu">as.data.table</span>(count, <span class="at">keep.rownames =</span> <span class="st">"node"</span>),</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="st">"node"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  num_cols <span class="ot">&lt;-</span> <span class="fu">colnames</span>(count)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> dt[</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">lapply</span>(.SD, sum), </span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    .SDcols <span class="ot">=</span> num_cols, by <span class="ot">=</span> <span class="st">"bin"</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    , (num_cols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, fProportions), .SDcols <span class="ot">=</span> num_cols</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(DT, <span class="at">rownames =</span> <span class="st">"bin"</span>)</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale proportions</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>  scaling <span class="ot">&lt;-</span> scaling[<span class="fu">order</span>(<span class="fu">match</span>(<span class="fu">names</span>(scaling), <span class="fu">rownames</span>(m)))]</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sweep</span>(m, <span class="dv">1</span>, scaling, <span class="st">"*"</span>)</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>MAG_relativeActivity <span class="ot">&lt;-</span> <span class="fu">calcRelativeActivity</span>(</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>  COUNTS<span class="sc">$</span>WTS, GENOMESIZE, ANNOTATION[, <span class="fu">c</span>(<span class="st">"bin"</span>, <span class="st">"node"</span>)]</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>node2bin <span class="ot">&lt;-</span> <span class="fu">set_names</span>(</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>(ANNOTATION<span class="sc">$</span>bin),</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>(ANNOTATION<span class="sc">$</span>node)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>node2bin <span class="ot">&lt;-</span> node2bin[<span class="fu">order</span>(<span class="fu">match</span>(<span class="fu">names</span>(node2bin), <span class="fu">rownames</span>(TPM<span class="sc">$</span>WTS)))]</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>bin_tpm <span class="ot">&lt;-</span> <span class="fu">rowsum</span>(TPM<span class="sc">$</span>WTS, node2bin) <span class="co"># used as an output generator</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>bin_tpm_mean <span class="ot">&lt;-</span> bin_tpm</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(TPM<span class="sc">$</span>WTS)) {</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  bin_tpm_mean[, j] <span class="ot">&lt;-</span> <span class="fu">tapply</span>(TPM<span class="sc">$</span>WTS[, j], node2bin, mean)</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(j)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Applying an arbitrary threshold:</p>
<p>A MAG is active if it has a mean TPM <span class="math inline">\(\ge 5\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>MAG_active <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bin_tpm_mean <span class="sc">&lt;</span> <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative frequency</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>xlim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bin_tpm_mean), <span class="fu">max</span>(bin_tpm_mean))</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>ylim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(bin_tpm_mean))</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim =</span> xlim, <span class="at">ylim =</span> ylim, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Cumulative number of MAGs"</span>, <span class="at">xlab =</span> <span class="st">"MAG TPM"</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(bin_tpm_mean)) {</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>  color <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, <span class="fu">colnames</span>(bin_tpm_mean)[j]), <span class="st">"cornflowerblue"</span>, <span class="st">"firebrick2"</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">sort</span>(bin_tpm_mean[, j])</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>  br <span class="ot">&lt;-</span> <span class="fu">pretty</span>(x, <span class="at">n =</span> <span class="dv">25</span>)</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">table</span>(<span class="fu">cut</span>(x, br)))</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">0</span>, cf) <span class="sc">~</span> br, <span class="at">col =</span> color)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fl">0.1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(xlim, ylim, j, color, x, br, cf)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">colSums</span>(MAG_active), </span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, <span class="fu">colnames</span>(bin_tpm_mean)), </span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"cornflowerblue"</span>, <span class="st">"firebrick2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-14-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="functional-redundancy-and-competition" class="level1">
<h1>Functional redundancy and competition</h1>
<blockquote class="blockquote">
<p>Functional redundancy is the potential for competition</p>
</blockquote>
<p>The level of functional redundancy is tied to how the function is categorised. Functional redundancy here is defined as follows:</p>
<ol type="1">
<li>Function: Endolytic, polysaccharide-degrading GH and PL with assigned EC numbers</li>
<li>Redundancy: The number of populations that are putatively capable of performing the function estimated based on per population aggregate of metagenomic gene presence-absence data.</li>
</ol>
<p>A contrasting picture against terminal CAZymes would be great.</p>
<p>This analysis will first explore functional redundancy partitioned by habitat substrate (water column and sediment). Following that, the analysis will be partitioned along the salinity gradient per habitat substrate.</p>
<p>The same analysis is run for transcriptomic data to ascertain competition.</p>
<section id="define-substrates-and-cazymes" class="level2">
<h2 class="anchored" data-anchor-id="define-substrates-and-cazymes">Define substrates and CAZymes</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>endozyme <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3.2.1.4"</span>, </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3.2.1.1"</span>, </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3.2.1.8"</span>, </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3.2.1.78"</span>,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3.2.1.14"</span>,</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"laminarin"</span>, </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pectin"</span>,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"alginate"</span>, </span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ulvan"</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(endozyme) <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grepl</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d"</span>, endozyme), </span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"cellulose"</span>, <span class="st">"starch_glycogen"</span>, <span class="st">"xylan"</span>, <span class="st">"beta_mannan"</span>, <span class="st">"chitin"</span>),</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>  endozyme</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>exozyme <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_Glc"</span> <span class="ot">=</span> <span class="st">"3.2.1.21"</span>, </span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"a_Glc"</span> <span class="ot">=</span> <span class="st">"3.2.1.20"</span>, </span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_Gal"</span> <span class="ot">=</span> <span class="st">"3.2.1.23"</span>, </span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"a_Man"</span> <span class="ot">=</span> <span class="st">"3.2.1.24"</span>, </span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_Man"</span> <span class="ot">=</span> <span class="st">"3.2.1.25"</span>,</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_Xyl"</span> <span class="ot">=</span> <span class="st">"3.2.1.37"</span>, </span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_Fuc"</span> <span class="ot">=</span> <span class="st">"3.2.1.38"</span>, </span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"a_Rha"</span> <span class="ot">=</span> <span class="st">"3.2.1.40"</span>,</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"a_LFuc"</span> <span class="ot">=</span> <span class="st">"3.2.1.51"</span>,</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"b_HexNAc"</span> <span class="ot">=</span> <span class="st">"3.2.1.52"</span>,</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"a_LAraf"</span> <span class="ot">=</span> <span class="st">"3.2.1.55"</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-genes-and-transcripts" class="level2">
<h2 class="anchored" data-anchor-id="get-genes-and-transcripts">Get genes and transcripts</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>endozyme <span class="ot">&lt;-</span> <span class="fu">lapply</span>(endozyme, \(s) {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d"</span>, s)) {</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">findCAZymes</span>(s)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do not capture:</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Laminarin: 3.2.1.73 &amp; 3.2.1.75</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">getCAZyBySubstrate</span>(s, <span class="st">"endo"</span>, <span class="fu">c</span>(<span class="st">"GH"</span>, <span class="st">"PL"</span>))</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (s <span class="sc">==</span> <span class="st">"laminarin"</span>) {</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>      a<span class="sc">$</span>EC <span class="ot">&lt;-</span> a<span class="sc">$</span>EC[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"(3.2.1.73|3.2.1.75)"</span>, a<span class="sc">$</span>EC)]</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">findCAZymes</span>(a)</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>exozyme <span class="ot">&lt;-</span> <span class="fu">lapply</span>(exozyme, findCAZymes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="basic-stats" class="level2">
<h2 class="anchored" data-anchor-id="basic-stats">Basic stats</h2>
<p>Number of bins with function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(endozyme, \(l) l<span class="sc">$</span>WTS) <span class="sc">%&gt;%</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapplyAtDepth</span>(<span class="dv">2</span>, \(dt) dt<span class="sc">$</span>bin) <span class="sc">%&gt;%</span> </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unwrap</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 99</code></pre>
</div>
</div>
<p>Checking family-EC matches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>chkECfam <span class="ot">&lt;-</span> <span class="cf">function</span>(subs, x) {</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    endozyme[[subs]]<span class="sc">$</span>WGS, </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    \(dt) {</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>      dt[<span class="fu">sapply</span>(EC, \(s) x <span class="sc">%in%</span> s), .(FAMILY, EC)]<span class="sc">$</span>FAMILY</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unwrap</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_sort</span>(<span class="at">numeric =</span> T)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="fu">chkECfam</span>(<span class="st">"ulvan"</span>, <span class="st">"4.2.2.-"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PL24" "PL28" "PL40"</code></pre>
</div>
</div>
<p>How many MAGs capable?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(endozyme<span class="sc">$</span>cellulose<span class="sc">$</span>WGS, \(dt) <span class="fu">length</span>(<span class="fu">unwrap</span>(dt<span class="sc">$</span>bin)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$water
[1] 27

$sediment
[1] 34</code></pre>
</div>
</div>
</section>
<section id="sub-functions-for-aggregating-bins" class="level2">
<h2 class="anchored" data-anchor-id="sub-functions-for-aggregating-bins">Sub-functions for aggregating bins</h2>
<p><strong>Redundancy within habitat substrate</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>getHabitatRedundancy <span class="ot">&lt;-</span> <span class="cf">function</span>(LIST, srctype, <span class="at">constraint=</span><span class="cn">NULL</span>) {</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(constraint)) {</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    is.mat <span class="ot">&lt;-</span> <span class="fu">is.matrix</span>(constraint)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    has.rn <span class="ot">&lt;-</span> <span class="fu">is.character</span>(<span class="fu">rownames</span>(constraint))</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    is.bin <span class="ot">&lt;-</span> <span class="fu">is.numeric</span>(constraint) <span class="sc">&amp;</span> <span class="fu">min</span>(constraint) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">max</span>(constraint) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(is.mat, has.rn, is.bin)) </span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"constraint must be a binary matrix with MAG/bin names as rownames."</span>)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(LIST, \(l) l[[srctype]]) <span class="sc">%&gt;%</span> </span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapplyAtDepth</span>(<span class="dv">2</span>, \(dt) {</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get bins from non-zero counts</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>      bin <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>bin)</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(constraint)) <span class="fu">return</span>(bin)</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Constrain to thresholded MAGs</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>      common_col <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">colnames</span>(constraint), <span class="fu">names</span>(dt))</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>      mags <span class="ot">&lt;-</span> <span class="fu">rownames</span>(constraint)[<span class="fu">rowSums</span>(constraint[, common_col]) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">intersect</span>(bin, mags)</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Redundancy across salinity</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>getSalinityRedundancy <span class="ot">&lt;-</span> <span class="cf">function</span>(LIST, srctype, <span class="at">constraint=</span><span class="cn">NULL</span>) {</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(constraint)) {</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    is.mat <span class="ot">&lt;-</span> <span class="fu">is.matrix</span>(constraint)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    has.rn <span class="ot">&lt;-</span> <span class="fu">is.character</span>(<span class="fu">rownames</span>(constraint))</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    is.bin <span class="ot">&lt;-</span> <span class="fu">is.numeric</span>(constraint) <span class="sc">&amp;</span> <span class="fu">min</span>(constraint) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">max</span>(constraint) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(is.mat, has.rn, is.bin)) </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"constraint must be a binary matrix with MAG/bin names as rownames."</span>)</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(LIST, \(l) l[[srctype]]) <span class="sc">%&gt;%</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapplyAtDepth</span>(<span class="dv">2</span>, \(dt) {</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Sum per sample by bin</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>      bin_dt <span class="ot">&lt;-</span> dt[</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>        , .SD,</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>        .SDcols <span class="ot">=</span> <span class="fu">patterns</span>(<span class="st">"bin|Sed|Filt"</span>)</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>      ][</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>        , <span class="fu">lapply</span>(.SD, sum), by <span class="ot">=</span> <span class="st">"bin"</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Binary conversion</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>      binary_dt <span class="ot">&lt;-</span> <span class="fu">copy</span>(bin_dt)</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>      numcols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Sed|Filt"</span>, <span class="fu">colnames</span>(binary_dt), <span class="at">value =</span> T)</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>      binary_dt[, (numcols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, \(x) <span class="fu">ifelse</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>                .SDcols <span class="ot">=</span> <span class="fu">patterns</span>(<span class="st">"Sed|Filt"</span>)]</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>      binary_m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(binary_dt, <span class="at">rownames =</span> <span class="st">"bin"</span>)</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(constraint)) <span class="fu">return</span>(<span class="fu">colSums</span>(binary_m))</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check against MAG constraints</span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>      mags <span class="ot">&lt;-</span> constraint[<span class="fu">rownames</span>(constraint) <span class="sc">%in%</span> bin_dt<span class="sc">$</span>bin, </span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">colnames</span>(constraint) <span class="sc">%in%</span> <span class="fu">colnames</span>(binary_dt)]</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mags can be vector if only 1 bin, modify operations for larger than 2</span></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.matrix</span>(mags) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(mags) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>        mags <span class="ot">&lt;-</span> mags[<span class="fu">order</span>(<span class="fu">match</span>(<span class="fu">rownames</span>(mags), bin_dt<span class="sc">$</span>bin)), ]</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colSums</span>(binary_m <span class="sc">*</span> mags)</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">list_transpose</span>() <span class="sc">%&gt;%</span></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(\(l) <span class="fu">as.data.table</span>(<span class="fu">as.data.frame</span>(l), <span class="at">keep.rownames =</span> <span class="st">"sample"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>()</span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="functional-redundancy" class="level2">
<h2 class="anchored" data-anchor-id="functional-redundancy">Functional redundancy</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>FR_habitat <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"endo"</span> <span class="ot">=</span> <span class="fu">getHabitatRedundancy</span>(endozyme, <span class="st">"WGS"</span>, MAG_present),</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exo"</span> <span class="ot">=</span> <span class="fu">getHabitatRedundancy</span>(exozyme, <span class="st">"WGS"</span>, MAG_present)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>FR_habitat_dt <span class="ot">&lt;-</span> <span class="fu">lapplyAtDepth</span>(FR_habitat, <span class="dv">3</span>, length) <span class="sc">%&gt;%</span> </span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(\(l) {</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">list_transpose</span>(l) <span class="sc">%&gt;%</span> </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.frame</span>(., <span class="at">row.names =</span> <span class="fu">names</span>(l)) <span class="sc">%&gt;%</span> </span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.table</span>(., <span class="at">keep.rownames =</span> <span class="st">"substrate"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>      .[<span class="fu">order</span>(water)]</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale by number of MAGs present in each habitat</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    mag_present <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Filt"</span>, <span class="st">"Sed"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(., <span class="fu">c</span>(<span class="st">"water"</span>, <span class="st">"sediment"</span>))</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    mag_present <span class="ot">&lt;-</span> <span class="fu">sapply</span>(mag_present, \(x) {</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> MAG_present[, <span class="fu">grepl</span>(x, <span class="fu">colnames</span>(MAG_present))]</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(<span class="fu">rowsums</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"water"</span>, <span class="st">"sediment"</span>)) {</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>      nm <span class="ot">&lt;-</span> <span class="fu">paste0</span>(i, <span class="st">"_scaled"</span>)</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>      dt[, (nm) <span class="sc">:</span><span class="er">=</span> .SD[[i]] <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> mag_present[[i]]]</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(dt)</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>FR_salinity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"endo"</span> <span class="ot">=</span> <span class="fu">getSalinityRedundancy</span>(endozyme, <span class="st">"WGS"</span>, MAG_present),</span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exo"</span> <span class="ot">=</span> <span class="fu">getSalinityRedundancy</span>(exozyme, <span class="st">"WGS"</span>, MAG_present)</span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>FR_salinity_scaled <span class="ot">&lt;-</span> <span class="fu">lapply</span>(FR_salinity, \(dt) {</span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt, <span class="at">rownames =</span> <span class="st">"sample"</span>)</span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(</span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sweep</span>(m, <span class="dv">1</span>, <span class="fu">colSums</span>(MAG_present), <span class="st">"/"</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">keep.rownames =</span> <span class="st">"sample"</span></span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot results: Habitat</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>barplot_FR_habitat <span class="ot">&lt;-</span> <span class="fu">lapply</span>(FR_habitat_dt, \(dt) {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data preparation</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt[, <span class="fu">c</span>(<span class="st">"substrate"</span>, <span class="st">"water_scaled"</span>, <span class="st">"sediment_scaled"</span>)], </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"water_scaled"</span>, <span class="st">"sediment_scaled"</span>), </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">variable.name =</span> <span class="st">"habitat"</span>)</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">$</span>habitat <span class="ot">&lt;-</span> <span class="fu">factor</span>(DT<span class="sc">$</span>habitat, </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"sediment_scaled"</span>, <span class="st">"water_scaled"</span>),</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"sediment"</span>, <span class="st">"water"</span>))</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">$</span>substrate <span class="ot">&lt;-</span> <span class="fu">factor</span>(DT<span class="sc">$</span>substrate, <span class="at">levels =</span> dt<span class="sc">$</span>substrate)</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>  upper.lim <span class="ot">&lt;-</span> <span class="fu">max</span>(DT<span class="sc">$</span>value) <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DT) <span class="sc">+</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="fu">aes</span>(</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> substrate, </span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> value, </span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> habitat</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>      ), <span class="at">position =</span> <span class="st">"dodge"</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Percent MAGs with function relative to richness"</span>,</span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Putative substrate"</span>,</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Habitat substrate"</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> habitat_colour, <span class="at">labels =</span> str_to_title) <span class="sc">+</span></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), </span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, upper.lim)</span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> DT, <span class="st">"figure"</span> <span class="ot">=</span> pl))</span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a>barplot_FR_habitat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$endo
$endo$data
          substrate  habitat      value
             &lt;fctr&gt;   &lt;fctr&gt;      &lt;num&gt;
 1:           ulvan    water  1.5625000
 2:           xylan    water  5.7291667
 3:     beta_mannan    water  5.7291667
 4:        alginate    water  6.7708333
 5:          pectin    water  7.8125000
 6:          chitin    water  9.3750000
 7:       cellulose    water 10.9375000
 8: starch_glycogen    water 26.5625000
 9:       laminarin    water 41.1458333
10:           ulvan sediment  0.5235602
11:           xylan sediment 10.4712042
12:     beta_mannan sediment 10.4712042
13:        alginate sediment  6.8062827
14:          pectin sediment 10.4712042
15:          chitin sediment 13.6125654
16:       cellulose sediment 17.2774869
17: starch_glycogen sediment 29.8429319
18:       laminarin sediment 35.0785340

$endo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-22-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

$exo
$exo$data
    substrate  habitat     value
       &lt;fctr&gt;   &lt;fctr&gt;     &lt;num&gt;
 1:     b_Fuc    water  3.645833
 2:     a_Man    water  8.333333
 3:     b_Man    water 11.458333
 4:     a_Rha    water 15.104167
 5:   a_LAraf    water 16.666667
 6:    a_LFuc    water 17.708333
 7:     b_Xyl    water 23.437500
 8:     b_Gal    water 23.958333
 9:     a_Glc    water 31.250000
10:     b_Glc    water 52.083333
11:  b_HexNAc    water 64.062500
12:     b_Fuc sediment  6.282723
13:     a_Man sediment 10.994764
14:     b_Man sediment 11.518325
15:     a_Rha sediment 17.277487
16:   a_LAraf sediment 19.895288
17:    a_LFuc sediment 18.324607
18:     b_Xyl sediment 24.607330
19:     b_Gal sediment 30.366492
20:     a_Glc sediment 36.125654
21:     b_Glc sediment 48.691099
22:  b_HexNAc sediment 70.157068
    substrate  habitat     value

$exo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-22-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Plot results: Salinity</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>heatmap_FR_salinity <span class="ot">&lt;-</span> <span class="fu">lapply</span>(FR_salinity_scaled, \(dt) {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Hierarchical clustering of substrate</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt, <span class="at">rownames =</span> <span class="st">"sample"</span>)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">dist</span>(<span class="fu">t</span>(m)), <span class="at">method =</span> <span class="st">"complete"</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  substrate.order <span class="ot">&lt;-</span> h<span class="sc">$</span>labels[h<span class="sc">$</span>order]</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data preparation</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt, <span class="at">id.vars =</span> <span class="st">"sample"</span>, <span class="at">variable.name =</span> <span class="st">"substrate"</span>)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> DT[</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">substrate =</span> <span class="fu">factor</span>(substrate, <span class="at">levels =</span> substrate.order),</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">sample =</span> <span class="fu">factor</span>(sample, <span class="at">levels =</span> dt<span class="sc">$</span>sample),</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">habitat =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, sample), <span class="st">"Water"</span>, <span class="st">"Sediment"</span>))</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    , habitat <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(habitat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Water"</span>, <span class="st">"Sediment"</span>))</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DT) <span class="sc">+</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> sample, </span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> substrate, </span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> value</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Sample"</span>,</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Putative substrates"</span>,</span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Percent MAGs relative to richness"</span></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">cols =</span> <span class="fu">vars</span>(habitat), <span class="at">space =</span> <span class="st">"free_x"</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> DT, <span class="st">"hclust"</span> <span class="ot">=</span> h, <span class="st">"figure"</span> <span class="ot">=</span> pl)</span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>heatmap_FR_salinity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$endo
$endo$data
        sample substrate     value  habitat
        &lt;fctr&gt;    &lt;fctr&gt;     &lt;num&gt;   &lt;fctr&gt;
  1: Filt.S1_1 cellulose  2.857143    Water
  2: Filt.S2_1 cellulose  3.125000    Water
  3: Filt.S3_1 cellulose 10.457516    Water
  4: Filt.S4_1 cellulose  9.259259    Water
  5: Filt.S5_1 cellulose  8.982036    Water
 ---                                       
320:  Sed.S8_2     ulvan  0.000000 Sediment
321:  Sed.S8_3     ulvan  0.000000 Sediment
322:  Sed.S9_1     ulvan  0.000000 Sediment
323:  Sed.S9_2     ulvan  0.000000 Sediment
324:  Sed.S9_3     ulvan  0.000000 Sediment

$endo$hclust

Call:
hclust(d = dist(t(m)), method = "complete")

Cluster method   : complete 
Distance         : euclidean 
Number of objects: 9 


$endo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-23-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

$exo
$exo$data
        sample substrate     value  habitat
        &lt;fctr&gt;    &lt;fctr&gt;     &lt;num&gt;   &lt;fctr&gt;
  1: Filt.S1_1     b_Glc 54.285714    Water
  2: Filt.S2_1     b_Glc 53.125000    Water
  3: Filt.S3_1     b_Glc 53.594771    Water
  4: Filt.S4_1     b_Glc 48.148148    Water
  5: Filt.S5_1     b_Glc 47.904192    Water
 ---                                       
392:  Sed.S8_2   a_LAraf 12.000000 Sediment
393:  Sed.S8_3   a_LAraf 12.162162 Sediment
394:  Sed.S9_1   a_LAraf  8.450704 Sediment
395:  Sed.S9_2   a_LAraf  9.589041 Sediment
396:  Sed.S9_3   a_LAraf  8.571429 Sediment

$exo$hclust

Call:
hclust(d = dist(t(m)), method = "complete")

Cluster method   : complete 
Distance         : euclidean 
Number of objects: 11 


$exo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-23-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="competition" class="level2">
<h2 class="anchored" data-anchor-id="competition">Competition</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Constraint active MAGs with those present</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>cp_constraint <span class="ot">&lt;-</span> MAG_present[</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(<span class="fu">match</span>(<span class="fu">rownames</span>(MAG_present), <span class="fu">rownames</span>(MAG_active))),</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(MAG_present) <span class="sc">%in%</span> <span class="fu">colnames</span>(MAG_active)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>cp_constraint <span class="ot">&lt;-</span> MAG_active <span class="sc">*</span> cp_constraint</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>CP_habitat <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"endo"</span> <span class="ot">=</span> <span class="fu">getHabitatRedundancy</span>(endozyme, <span class="st">"WTS"</span>, cp_constraint),</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exo"</span> <span class="ot">=</span> <span class="fu">getHabitatRedundancy</span>(exozyme, <span class="st">"WTS"</span>, cp_constraint)</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>CP_habitat_dt <span class="ot">&lt;-</span> <span class="fu">lapplyAtDepth</span>(CP_habitat, <span class="dv">3</span>, length) <span class="sc">%&gt;%</span> </span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(\(l) {</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">list_transpose</span>(l) <span class="sc">%&gt;%</span> </span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.frame</span>(., <span class="at">row.names =</span> <span class="fu">names</span>(l)) <span class="sc">%&gt;%</span> </span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.table</span>(., <span class="at">keep.rownames =</span> <span class="st">"substrate"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>      .[<span class="fu">order</span>(water)]</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale by number of MAGs present in each habitat</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>    mag_present <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Filt"</span>, <span class="st">"Sed"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(., <span class="fu">c</span>(<span class="st">"water"</span>, <span class="st">"sediment"</span>))</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>    mag_present <span class="ot">&lt;-</span> <span class="fu">sapply</span>(mag_present, \(x) {</span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> cp_constraint[, <span class="fu">grepl</span>(x, <span class="fu">colnames</span>(cp_constraint))]</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(<span class="fu">rowsums</span>(m) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"water"</span>, <span class="st">"sediment"</span>)) {</span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>      nm <span class="ot">&lt;-</span> <span class="fu">paste0</span>(i, <span class="st">"_scaled"</span>)</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>      dt[, (nm) <span class="sc">:</span><span class="er">=</span> .SD[[i]] <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> mag_present[[i]]]</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(dt)</span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>CP_salinity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"endo"</span> <span class="ot">=</span> <span class="fu">getSalinityRedundancy</span>(endozyme, <span class="st">"WTS"</span>, cp_constraint),</span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exo"</span> <span class="ot">=</span> <span class="fu">getSalinityRedundancy</span>(exozyme, <span class="st">"WTS"</span>, cp_constraint)</span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>CP_salinity_scaled <span class="ot">&lt;-</span> <span class="fu">lapply</span>(CP_salinity, \(dt) {</span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt, <span class="at">rownames =</span> <span class="st">"sample"</span>)</span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(</span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sweep</span>(m, <span class="dv">1</span>, <span class="fu">colSums</span>(cp_constraint), <span class="st">"/"</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">keep.rownames =</span> <span class="st">"sample"</span></span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot results: Habitat</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>barplot_CP_habitat <span class="ot">&lt;-</span> <span class="fu">lapply</span>(CP_habitat_dt, \(dt) {</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data preparation</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt[, <span class="fu">c</span>(<span class="st">"substrate"</span>, <span class="st">"water_scaled"</span>, <span class="st">"sediment_scaled"</span>)], </span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"water_scaled"</span>, <span class="st">"sediment_scaled"</span>), </span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">variable.name =</span> <span class="st">"habitat"</span>)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">$</span>habitat <span class="ot">&lt;-</span> <span class="fu">factor</span>(DT<span class="sc">$</span>habitat, </span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"sediment_scaled"</span>, <span class="st">"water_scaled"</span>),</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"sediment"</span>, <span class="st">"water"</span>))</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">$</span>substrate <span class="ot">&lt;-</span> <span class="fu">factor</span>(DT<span class="sc">$</span>substrate, <span class="at">levels =</span> dt<span class="sc">$</span>substrate)</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  upper.lim <span class="ot">&lt;-</span> <span class="fu">max</span>(DT<span class="sc">$</span>value) <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DT) <span class="sc">+</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="fu">aes</span>(</span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> substrate, </span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> value, </span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> habitat</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>      ), <span class="at">position =</span> <span class="st">"dodge"</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Percent MAGs with function relative to all active MAGs"</span>,</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Putative substrate"</span>,</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Habitat substrate"</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> habitat_colour, <span class="at">labels =</span> str_to_title) <span class="sc">+</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), </span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, upper.lim)</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> DT, <span class="st">"figure"</span> <span class="ot">=</span> pl))</span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>barplot_CP_habitat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$endo
$endo$data
          substrate  habitat     value
             &lt;fctr&gt;   &lt;fctr&gt;     &lt;num&gt;
 1:       cellulose    water  2.000000
 2:     beta_mannan    water  2.000000
 3:           ulvan    water  2.000000
 4:           xylan    water  4.000000
 5:          chitin    water  4.000000
 6:          pectin    water  6.000000
 7:        alginate    water  6.000000
 8: starch_glycogen    water 38.000000
 9:       laminarin    water 44.000000
10:       cellulose sediment  9.090909
11:     beta_mannan sediment  5.454545
12:           ulvan sediment  0.000000
13:           xylan sediment  1.818182
14:          chitin sediment  3.636364
15:          pectin sediment  9.090909
16:        alginate sediment  0.000000
17: starch_glycogen sediment 20.000000
18:       laminarin sediment 18.181818

$endo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-24-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

$exo
$exo$data
    substrate  habitat     value
       &lt;fctr&gt;   &lt;fctr&gt;     &lt;num&gt;
 1:     b_Fuc    water  4.000000
 2:     a_Man    water  8.000000
 3:   a_LAraf    water  8.000000
 4:     b_Man    water 12.000000
 5:     b_Gal    water 16.000000
 6:     a_Rha    water 16.000000
 7:    a_LFuc    water 22.000000
 8:     b_Xyl    water 24.000000
 9:     a_Glc    water 40.000000
10:     b_Glc    water 52.000000
11:  b_HexNAc    water 60.000000
12:     b_Fuc sediment  1.818182
13:     a_Man sediment  7.272727
14:   a_LAraf sediment 12.727273
15:     b_Man sediment  3.636364
16:     b_Gal sediment 14.545455
17:     a_Rha sediment 12.727273
18:    a_LFuc sediment  9.090909
19:     b_Xyl sediment 18.181818
20:     a_Glc sediment 21.818182
21:     b_Glc sediment 38.181818
22:  b_HexNAc sediment 43.636364
    substrate  habitat     value

$exo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-24-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Plot results: Salinity</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>heatmap_CP_salinity <span class="ot">&lt;-</span> <span class="fu">lapply</span>(CP_salinity_scaled, \(dt) {</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Hierarchical clustering of substrate</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dt, <span class="at">rownames =</span> <span class="st">"sample"</span>)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">dist</span>(<span class="fu">t</span>(m)), <span class="at">method =</span> <span class="st">"complete"</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  substrate.order <span class="ot">&lt;-</span> h<span class="sc">$</span>labels[h<span class="sc">$</span>order]</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data preparation</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt, <span class="at">id.vars =</span> <span class="st">"sample"</span>, <span class="at">variable.name =</span> <span class="st">"substrate"</span>)</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  DT[</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">substrate =</span> <span class="fu">factor</span>(substrate, <span class="at">levels =</span> substrate.order),</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">sample =</span> <span class="fu">factor</span>(sample, <span class="at">levels =</span> dt<span class="sc">$</span>sample),</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">habitat =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, sample), <span class="st">"Water"</span>, <span class="st">"Sediment"</span>))</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    , habitat <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(habitat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Water"</span>, <span class="st">"Sediment"</span>))</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DT) <span class="sc">+</span></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> sample, </span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> substrate, </span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> value</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Sample"</span>,</span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Putative substrates"</span>,</span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Percent MAGs relative to all active MAGs"</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">cols =</span> <span class="fu">vars</span>(habitat), <span class="at">space =</span> <span class="st">"free_x"</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> DT, <span class="st">"hclust"</span> <span class="ot">=</span> h, <span class="st">"figure"</span> <span class="ot">=</span> pl)</span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>heatmap_CP_salinity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$endo
$endo$data
        sample substrate    value  habitat
        &lt;fctr&gt;    &lt;fctr&gt;    &lt;num&gt;   &lt;fctr&gt;
  1: Filt.S1_1 cellulose 3.846154    Water
  2: Filt.S2_1 cellulose 4.347826    Water
  3: Filt.S3_1 cellulose 0.000000    Water
  4: Filt.S4_1 cellulose 0.000000    Water
  5: Filt.S5_1 cellulose 0.000000    Water
 ---                                      
266:  Sed.S6_2     ulvan 0.000000 Sediment
267:  Sed.S6_3     ulvan 0.000000 Sediment
268:  Sed.S7_1     ulvan 0.000000 Sediment
269:  Sed.S7_2     ulvan 0.000000 Sediment
270:  Sed.S7_3     ulvan 0.000000 Sediment

$endo$hclust

Call:
hclust(d = dist(t(m)), method = "complete")

Cluster method   : complete 
Distance         : euclidean 
Number of objects: 9 


$endo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-25-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

$exo
$exo$data
        sample substrate    value  habitat
        &lt;fctr&gt;    &lt;fctr&gt;    &lt;num&gt;   &lt;fctr&gt;
  1: Filt.S1_1     b_Glc 46.15385    Water
  2: Filt.S2_1     b_Glc 52.17391    Water
  3: Filt.S3_1     b_Glc 40.00000    Water
  4: Filt.S4_1     b_Glc 35.00000    Water
  5: Filt.S5_1     b_Glc 33.33333    Water
 ---                                      
326:  Sed.S6_2   a_LAraf  0.00000 Sediment
327:  Sed.S6_3   a_LAraf  0.00000 Sediment
328:  Sed.S7_1   a_LAraf  0.00000 Sediment
329:  Sed.S7_2   a_LAraf  0.00000 Sediment
330:  Sed.S7_3   a_LAraf  0.00000 Sediment

$exo$hclust

Call:
hclust(d = dist(t(m)), method = "complete")

Cluster method   : complete 
Distance         : euclidean 
Number of objects: 11 


$exo$figure</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/unnamed-chunk-25-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="consolidating-the-plots" class="level2">
<h2 class="anchored" data-anchor-id="consolidating-the-plots">Consolidating the plots</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>FRCP_habitat <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Present"</span> <span class="ot">=</span> FR_habitat_dt<span class="sc">$</span>endo,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Active"</span> <span class="ot">=</span> CP_habitat_dt<span class="sc">$</span>endo</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(<span class="at">idcol =</span> <span class="st">"status"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  .[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">water_scaled =</span> <span class="cn">NULL</span>, <span class="at">sediment_scaled =</span> <span class="cn">NULL</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(<span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"water"</span>, <span class="st">"sediment"</span>), <span class="at">variable.name =</span> <span class="st">"habitat"</span>,</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">value.name =</span> <span class="st">"nMAG"</span>)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>FRCP_salinity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Present"</span> <span class="ot">=</span> FR_salinity<span class="sc">$</span>endo,</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Active"</span> <span class="ot">=</span> CP_salinity<span class="sc">$</span>endo</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(<span class="at">idcol =</span> <span class="st">"status"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(<span class="at">id.vars =</span> <span class="fu">c</span>(<span class="st">"status"</span>, <span class="st">"sample"</span>), <span class="at">variable.name =</span> <span class="st">"substrate"</span>, </span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">value.name =</span> <span class="st">"nMAG"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>  .[, habitat <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"Filt"</span>, sample), <span class="st">"water"</span>, <span class="st">"sediment"</span>)]</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor order</span></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>substrate_order <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"laminarin"</span>,</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"starch_glycogen"</span>,</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cellulose"</span>,</span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"chitin"</span>,</span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pectin"</span>,</span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"xylan"</span>,</span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"beta_mannan"</span>,</span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"alginate"</span>,</span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ulvan"</span></span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>FRCP_habitat[</span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a>  , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat =</span> <span class="fu">factor</span>(habitat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"sediment"</span>, <span class="st">"water"</span>)),</span>
<span id="cb116-34"><a href="#cb116-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">substrate =</span> <span class="fu">factor</span>(substrate, <span class="at">levels =</span> substrate_order)</span>
<span id="cb116-35"><a href="#cb116-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb116-36"><a href="#cb116-36" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb116-37"><a href="#cb116-37" aria-hidden="true" tabindex="-1"></a>FRCP_salinity[</span>
<span id="cb116-38"><a href="#cb116-38" aria-hidden="true" tabindex="-1"></a>  , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb116-39"><a href="#cb116-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Present"</span>, <span class="st">"Active"</span>)),</span>
<span id="cb116-40"><a href="#cb116-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat =</span> <span class="fu">factor</span>(habitat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"sediment"</span>, <span class="st">"water"</span>)),</span>
<span id="cb116-41"><a href="#cb116-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">substrate =</span> <span class="fu">factor</span>(substrate, <span class="at">levels =</span> substrate_order)</span>
<span id="cb116-42"><a href="#cb116-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb116-43"><a href="#cb116-43" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb116-44"><a href="#cb116-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-45"><a href="#cb116-45" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb116-46"><a href="#cb116-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb116-47"><a href="#cb116-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> FRCP_habitat[status <span class="sc">==</span> <span class="st">"Present"</span>],</span>
<span id="cb116-48"><a href="#cb116-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> substrate, <span class="at">y =</span> nMAG, <span class="at">fill =</span> habitat),</span>
<span id="cb116-49"><a href="#cb116-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb116-50"><a href="#cb116-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb116-51"><a href="#cb116-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb116-52"><a href="#cb116-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> FRCP_habitat[status <span class="sc">==</span> <span class="st">"Active"</span>],</span>
<span id="cb116-53"><a href="#cb116-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> substrate, <span class="at">y =</span> nMAG, <span class="at">fill =</span> habitat),</span>
<span id="cb116-54"><a href="#cb116-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"dodge"</span></span>
<span id="cb116-55"><a href="#cb116-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb116-56"><a href="#cb116-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> habitat_colour, <span class="at">labels =</span> str_to_sentence) <span class="sc">+</span></span>
<span id="cb116-57"><a href="#cb116-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb116-58"><a href="#cb116-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Substrate"</span>,</span>
<span id="cb116-59"><a href="#cb116-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Number of MAGs"</span>,</span>
<span id="cb116-60"><a href="#cb116-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Habitat substrate"</span>,</span>
<span id="cb116-61"><a href="#cb116-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Lighter bars indicate presence, darker indicate active."</span></span>
<span id="cb116-62"><a href="#cb116-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb116-63"><a href="#cb116-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb116-64"><a href="#cb116-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb116-65"><a href="#cb116-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb116-66"><a href="#cb116-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb116-67"><a href="#cb116-67" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/fr-cp-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>integer_breaks <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">5</span>, ...) {</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  fxn <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">pretty</span>(x, n, ...))</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(breaks) <span class="ot">&lt;-</span> <span class="fu">attr</span>(breaks, <span class="st">"labels"</span>)</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    breaks</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fxn)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> FRCP_salinity[status <span class="sc">==</span> <span class="st">"Present"</span>],</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> sample, <span class="at">x =</span> nMAG),</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"cornflowerblue"</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> FRCP_salinity[status <span class="sc">==</span> <span class="st">"Active"</span>],</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> sample, <span class="at">x =</span> nMAG),</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"firebrick"</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">integer_breaks</span>()) <span class="sc">+</span></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="at">cols =</span> <span class="fu">vars</span>(substrate), <span class="at">scales =</span> <span class="st">"fixed"</span>) <span class="sc">+</span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="analysis_workflow_files/figure-html/fr-cp-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">list</span>(</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Present"</span> <span class="ot">=</span> FR_habitat_dt<span class="sc">$</span>endo,</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Active"</span> <span class="ot">=</span> CP_habitat_dt<span class="sc">$</span>endo</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(<span class="at">idcol =</span> <span class="st">"status"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  .[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">water_scaled =</span> <span class="cn">NULL</span>, <span class="at">sediment_scaled =</span> <span class="cn">NULL</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">status</th>
<th style="text-align: left;">substrate</th>
<th style="text-align: right;">water</th>
<th style="text-align: right;">sediment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">ulvan</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">xylan</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">beta_mannan</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">alginate</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">pectin</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">chitin</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">26</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">cellulose</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">33</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">starch_glycogen</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">57</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">laminarin</td>
<td style="text-align: right;">79</td>
<td style="text-align: right;">67</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">cellulose</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">beta_mannan</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">ulvan</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">xylan</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">chitin</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">pectin</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">alginate</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">starch_glycogen</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">laminarin</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">list</span>(</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Present"</span> <span class="ot">=</span> FR_salinity<span class="sc">$</span>endo,</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Active"</span> <span class="ot">=</span> CP_salinity<span class="sc">$</span>endo</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(<span class="at">idcol =</span> <span class="st">"status"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 5%">
<col style="width: 11%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">status</th>
<th style="text-align: left;">sample</th>
<th style="text-align: right;">cellulose</th>
<th style="text-align: right;">starch_glycogen</th>
<th style="text-align: right;">xylan</th>
<th style="text-align: right;">beta_mannan</th>
<th style="text-align: right;">chitin</th>
<th style="text-align: right;">laminarin</th>
<th style="text-align: right;">pectin</th>
<th style="text-align: right;">alginate</th>
<th style="text-align: right;">ulvan</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S1_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S2_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S3_1</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S4_1</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S5_1</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S6_1</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S7_1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S8_1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Filt.S9_1</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S1_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S1_2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S1_3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S2_1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S2_2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S2_3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S3_1</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S3_2</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S3_3</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S4_1</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S4_2</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S4_3</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S5_1</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S5_2</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S5_3</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S6_1</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S6_2</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S6_3</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S7_1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S7_2</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S7_3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S8_1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S8_2</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S8_3</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S9_1</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S9_2</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Present</td>
<td style="text-align: left;">Sed.S9_3</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S1_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S2_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S3_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S4_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S5_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S6_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S7_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S8_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Filt.S9_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S1_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S1_2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S1_3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S2_1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S2_2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S2_3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S3_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S3_2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S3_3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S4_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S4_2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S4_3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S5_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S5_2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S5_3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S6_1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S6_2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S6_3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S7_1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S7_2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Active</td>
<td style="text-align: left;">Sed.S7_3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="biogeochemical-cycling-and-carbohydrate-depolymerisation" class="level1">
<h1>Biogeochemical cycling and carbohydrate depolymerisation</h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>